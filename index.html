<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>TV Viannay Race Esporte</title>
    
    <meta name="theme-color" content="#121212"/>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --cor-branca: #FFFFFF; --cor-preta: #121212; --cor-cinza: #F0F2F5;
            --cor-cinza-escuro: #8A8A8A; --cor-destaque: #E53935; --cor-sucesso: #4CAF50;
            --cor-aviso: #FFC107; --cor-azul: #1976D2;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--cor-cinza); color: var(--cor-preta);
            overscroll-behavior-y: contain;
        }
        #app-container {
            display: flex; flex-direction: column; height: 100vh;
            max-width: 600px; margin: 0 auto; background-color: var(--cor-branca);
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        header {
            background-color: var(--cor-preta); color: var(--cor-branca); padding: 15px 20px;
            text-align: center; font-size: 1.2rem; font-weight: bold; flex-shrink: 0;
        }
        main { flex-grow: 1; overflow-y: auto; padding: 20px; }
        nav {
            display: flex; justify-content: space-around; background-color: var(--cor-branca);
            border-top: 1px solid #ddd; padding: 10px 0; flex-shrink: 0;
        }
        .nav-button {
            background: none; border: none; color: var(--cor-cinza-escuro); display: flex;
            flex-direction: column; align-items: center; font-size: 0.7rem;
            cursor: pointer; transition: color 0.2s; width: 20%;
        }
        .nav-button.active { color: var(--cor-destaque); font-weight: bold; }
        .nav-button svg { width: 24px; height: 24px; margin-bottom: 4px; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card {
            background-color: var(--cor-branca); border: 1px solid #e0e0e0;
            border-radius: 8px; padding: 16px; margin-bottom: 16px;
        }
        h2 { font-size: 1.5rem; margin-bottom: 16px; }
        h3 { font-size: 1.2rem; margin-bottom: 12px; border-left: 4px solid var(--cor-destaque); padding-left: 8px;}
        .btn {
            display: inline-block; width: 100%; padding: 12px; border: none;
            border-radius: 8px; font-size: 1rem; font-weight: bold;
            text-align: center; cursor: pointer; transition: opacity 0.2s;
        }
        .btn:active { opacity: 0.8; }
        .btn-principal { background-color: var(--cor-destaque); color: var(--cor-branca); }
        .btn-secundario { background-color: var(--cor-cinza); color: var(--cor-preta); }
        .btn-sucesso { background-color: var(--cor-sucesso); color: var(--cor-branca); }
        .btn-aviso { background-color: var(--cor-aviso); color: var(--cor-preta); }
        .input-group { margin-bottom: 16px; }
        .input-group label { display: block; margin-bottom: 6px; font-weight: 500; }
        .input-group input, .input-group select, .input-group textarea {
            width: 100%; padding: 10px; border: 1px solid #ccc;
            border-radius: 6px; font-size: 1rem;
        }
        .lista-item {
            display: flex; align-items: center; padding: 10px;
            border-bottom: 1px solid var(--cor-cinza);
        }
        .lista-item:last-child { border-bottom: none; }
        .item-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 12px; background-color: #eee; }
        .item-info { flex-grow: 1; }
        .item-info p { font-size: 1rem; font-weight: 500; }
        .item-info span { font-size: 0.8rem; color: #666; }
        .item-cor { width: 20px; height: 20px; border-radius: 50%; margin-right: 12px; border: 2px solid var(--cor-branca); box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        .action-buttons { display: flex; align-items: center; }
        .action-btn { background: none; border: none; cursor: pointer; padding: 5px; }
        .noticia-img {
            width: 100%; height: 150px; object-fit: cover;
            border-radius: 8px; margin-bottom: 12px;
        }
        .social-stats {
            display: flex; gap: 15px; margin-top: 10px; border-top: 1px solid #eee; padding-top: 8px;
            font-size: 0.85rem; color: #666; font-weight: 500;
        }
        .modal-backdrop {
            position: fixed; inset: 0; background-color: rgba(0,0,0,0.6);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 100;
        }
        .modal-backdrop.visible { opacity: 1; pointer-events: auto; }
        .modal-content {
            background-color: var(--cor-branca); border-radius: 12px; padding: 20px;
            width: 90%; max-width: 500px; max-height: 85vh;
            overflow-y: auto; transform: scale(0.95); transition: transform 0.3s;
        }
        .modal-backdrop.visible .modal-content { transform: scale(1); }
        .tabela { width: 100%; border-collapse: collapse; }
        .tabela th, .tabela td { padding: 8px; text-align: left; border-bottom: 1px solid #eee; vertical-align: middle; }
        .tabela th { font-size: 0.8rem; color: #666; }
        .tabela td.pos { font-weight: bold; width: 30px; }
        .tabela .piloto-info { display: flex; align-items: center; gap: 8px; }
        .tabela .piloto-info img { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
        .status {
            padding: 4px 8px; border-radius: 12px; font-size: 0.7rem;
            font-weight: bold; color: var(--cor-branca);
        }
        .status-espera { background-color: var(--cor-cinza-escuro); }
        .status-ativa { background-color: var(--cor-aviso); color: var(--cor-preta); }
        .status-finalizada { background-color: var(--cor-sucesso); }
        .tabs { display: flex; border-bottom: 1px solid #ccc; margin-bottom: 16px; overflow-x: auto; }
        .tab-button {
            padding: 10px 16px; cursor: pointer; background: none; border: none;
            border-bottom: 3px solid transparent; font-size: 1rem; white-space: nowrap;
        }
        .tab-button.active { border-bottom-color: var(--cor-destaque); font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="app-container">
        <header>TV Viannay Race Esporte</header>
        <main id="main-content">
            <div id="page-inicio" class="page active">
                <div id="selecao-temporada-view">
                    <h2>Gerenciador de Temporadas</h2>
                    <div id="lista-temporadas" class="card"></div>
                    <button id="btn-nova-temporada" class="btn btn-principal">Criar Nova Temporada</button>
                </div>
                <div id="dashboard-temporada-view" class="hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h2 id="temporada-nome" style="margin: 0;"></h2>
                        <button id="btn-mudar-temporada" class="btn btn-secundario" style="width: auto; padding: 8px 12px;">Mudar</button>
                    </div>
                    <div class="card">
                        <h3>Equipes</h3>
                        <div id="dashboard-lista-equipes"></div>
                    </div>
                    <div class="card">
                        <h3>Pilotos</h3>
                        <div id="dashboard-lista-pilotos"></div>
                    </div>
                    <div class="card">
                        <h3>√öltimas Not√≠cias</h3>
                        <div id="dashboard-lista-noticias"></div>
                    </div>
                </div>
            </div>

            <div id="page-calendario" class="page">
                <h2>Calend√°rio</h2>
                <div id="lista-corridas"></div>
            </div>
            
            <div id="page-classificacao" class="page">
                <h2>Classifica√ß√£o</h2>
                <div class="tabs">
                    <button class="tab-button active" data-tab="pilotos">Pilotos</button>
                    <button class="tab-button" data-tab="equipes">Equipes</button>
                    <button id="tab-btn-sprint" class="tab-button hidden" data-tab="sprint">Sprint</button>
                    <button class="tab-button" data-tab="fas">F√£s</button>
                </div>

                <div id="tab-pilotos" class="tab-content active">
                    <div class="card" style="padding: 0;">
                        <table class="tabela">
                            <thead><tr><th>Pos</th><th>Piloto</th><th>Pts</th></tr></thead>
                            <tbody id="tabela-pilotos"></tbody>
                        </table>
                    </div>
                </div>
                <div id="tab-equipes" class="tab-content">
                    <div style="margin-bottom: 20px;">
                        <button id="btn-ver-grafico" class="btn btn-secundario">Ver Gr√°fico de Evolu√ß√£o de Equipes</button>
                    </div>
                    <div class="card" style="padding: 0;">
                        <table class="tabela">
                            <thead><tr><th>Pos</th><th>Equipe</th><th>Pts</th></tr></thead>
                            <tbody id="tabela-equipes"></tbody>
                        </table>
                    </div>
                </div>
                <div id="tab-sprint" class="tab-content">
                    <p style="margin-bottom: 10px; font-size: 0.9rem; color: #666; padding: 0 10px;">Pontua√ß√£o apenas de corridas Sprint.</p>
                    <div class="card" style="padding: 0;">
                        <h4 style="padding: 10px; border-bottom: 1px solid #eee;">Pilotos (Sprint)</h4>
                        <table class="tabela">
                            <thead><tr><th>Pos</th><th>Piloto</th><th>Pts</th></tr></thead>
                            <tbody id="tabela-sprint-pilotos"></tbody>
                        </table>
                    </div>
                    <div class="card" style="padding: 0; margin-top: 15px;">
                        <h4 style="padding: 10px; border-bottom: 1px solid #eee;">Equipes (Sprint)</h4>
                        <table class="tabela">
                            <thead><tr><th>Pos</th><th>Equipe</th><th>Pts</th></tr></thead>
                            <tbody id="tabela-sprint-equipes"></tbody>
                        </table>
                    </div>
                </div>
                <div id="tab-fas" class="tab-content">
                    <div class="card" style="padding: 0;">
                        <table class="tabela">
                            <thead><tr><th>Pos</th><th>Piloto</th><th>F√£s</th></tr></thead>
                            <tbody id="tabela-fas"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="page-noticias" class="page">
                <h2>Not√≠cias</h2>
                <div id="lista-noticias"></div>
            </div>

            <div id="page-admin" class="page">
                <h2>Administra√ß√£o</h2>
                
                <div class="card" style="border-left: 4px solid var(--cor-aviso);">
                    <h3>Reparos e Configura√ß√µes</h3>
                    <div class="input-group" style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <input type="checkbox" id="check-separar-sprint" style="width: 20px; height: 20px;">
                        <label for="check-separar-sprint" style="margin: 0;">Separar Pontos da Sprint na Tabela</label>
                    </div>
                    <button id="btn-fix-noticias" class="btn btn-aviso">üõ†Ô∏è Corrigir Bug de Not√≠cias (Tela Branca)</button>
                </div>

                <div class="card">
                    <h3>Gerenciar Itens</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                        <button class="btn btn-secundario" data-action="add-equipe">Adicionar Equipe</button>
                        <button class="btn btn-secundario" data-action="add-piloto">Adicionar Piloto</button>
                        <button class="btn btn-secundario" data-action="add-corrida">Adicionar Etapa</button>
                        <button class="btn btn-secundario" data-action="add-noticia">Publicar Not√≠cia</button>
                    </div>
                </div>
                <div class="card">
                    <h3>Configura√ß√£o de Pontos</h3>
                    <form id="form-pontuacao">
                        <h4>Corrida Principal</h4>
                        <div id="pontos-corrida-container"></div>
                        <button type="button" class="btn-add-pos" data-tipo="corrida">+ Posi√ß√£o</button>
                        
                        <h4 style="margin-top:20px;">Corrida Sprint</h4>
                        <div id="pontos-sprint-container"></div>
                        <button type="button" class="btn-add-pos" data-tipo="sprint">+ Posi√ß√£o</button>

                        <h4 style="margin-top:20px;">Qualifica√ß√£o</h4>
                        <div id="pontos-quali-container"></div>
                        <button type="button" class="btn-add-pos" data-tipo="quali">+ Posi√ß√£o</button>
                        
                        <h4 style="margin-top:20px;">Ponto Extra</h4>
                        <div class="input-group">
                            <label for="ponto-volta-rapida">Pontos por Volta Mais R√°pida</label>
                            <input type="number" id="ponto-volta-rapida" min="0" value="1">
                        </div>
                        <button type="submit" class="btn btn-sucesso" style="margin-top: 20px;">Salvar Pontua√ß√£o</button>
                    </form>
                </div>
            </div>
        </main>
        
        <nav>
            <button class="nav-button active" data-page="inicio"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" /></svg>Temporada</button>
            <button class="nav-button" data-page="calendario"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0h18M-7.5 12h1.5" /></svg>Calend√°rio</button>
            <button class="nav-button" data-page="classificacao"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" /></svg>Tabela</button>
            <button class="nav-button" data-page="noticias"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375c.621 0 1.125.504 1.125 1.125V18a2.25 2.25 0 0 1-2.25 2.25M16.5 7.5V18a2.25 2.25 0 0 0 2.25 2.25M16.5 7.5V4.875c0-.621-.504-1.125-1.125-1.125H4.125C3.504 3.75 3 4.254 3 4.875V18a2.25 2.25 0 0 0 2.25 2.25h13.5A2.25 2.25 0 0 0 21 18.75h-18M-7.5 12h1.5" /></svg>Not√≠cias</button>
            <button class="nav-button" data-page="admin"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.343 3.94c.09-.542.56-.94 1.11-.94h1.093c.55 0 1.02.398 1.11.94l.149.894c.07.424.384.764.78.93.398.164.855.142 1.205-.108l.737-.527c.446-.318.99-.318 1.436 0l.775.775c.445.446.445 1.188 0 1.634l-.527.737c-.25.35-.272.806-.108 1.204.165.397.505.71.93.78l.893.15c.543.09.94.56.94 1.11v1.093c0 .55-.397 1.02-.94 1.11l-.893.149c-.425.07-.765.383-.93.78-.165.398-.143.854.108 1.204l.527.738c.446.445.446 1.187 0 1.634l-.775.775c-.446.446-1.188.446-1.634 0l-.738-.527c-.35-.25-.806-.272-1.204-.108-.397.165-.71.505-.78.93l-.15.893c-.09.543-.56.94-1.11.94h-1.093c-.55 0-1.02-.397-1.11-.94l-.149-.893c-.07-.425-.383-.765-.78-.93-.398-.165-.854-.143-1.204.108l-.738.527c-.445.446-1.187.446-1.634 0l-.775-.775c-.446-.445-.446-1.187 0-1.634l.527-.738c.25-.35.272-.806.108-1.204-.165-.397-.505-.71-.93-.78l-.894-.15c-.542-.09-.94-.56-.94-1.11v-1.093c0-.55.398-1.02.94-1.11l.894-.149c.424-.07.764-.383.93-.78.165-.398.143-.854-.108-1.204l-.527-.738c-.446-.445-.446-1.187 0-1.634l.775-.775c.446-.446 1.188-.446 1.634 0l.738.527c.35.25.806.272 1.204.108.397-.165.71-.505.78-.93l.15-.893Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>Admin</button>
        </nav>
    </div>

    <div id="modal-backdrop" class="modal-backdrop">
        <div id="modal-content" class="modal-content"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const APP_STORAGE_KEY = 'viannayRaceApp_v5';
            let state = {};
            let teamChart = null;

            const createNewSeason = (nome) => ({
                id: Date.now(),
                nome,
                separarSprint: false, // Nova config
                equipes: [],
                pilotos: [],
                calendario: [],
                noticias: [],
                pontuacao: {
                    corrida: { 1: 25, 2: 18, 3: 15, 4: 12, 5: 10, 6: 8, 7: 6, 8: 4, 9: 2, 10: 1 },
                    sprint: { 1: 8, 2: 7, 3: 6, 4: 5, 5: 4, 6: 3, 7: 2, 8: 1 },
                    quali: { 1: 3, 2: 2, 3: 1 },
                    voltaRapida: 1
                }
            });

            const saveState = () => {
                try {
                    localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(state));
                } catch (e) {
                    console.error("Erro ao salvar o estado:", e);
                    alert("N√£o foi poss√≠vel salvar os dados. O armazenamento pode estar cheio.");
                }
            };
            const loadState = () => {
                const savedState = localStorage.getItem(APP_STORAGE_KEY);
                if (savedState) {
                    state = JSON.parse(savedState);
                    // Migra√ß√£o de dados para vers√µes antigas
                    Object.values(state.seasons).forEach(s => {
                        if (typeof s.separarSprint === 'undefined') s.separarSprint = false;
                        if (s.noticias) {
                            s.noticias.forEach(n => {
                                if (typeof n.likes === 'undefined') n.likes = Math.floor(Math.random() * 500) + 10;
                                if (typeof n.comentarios === 'undefined') n.comentarios = Math.floor(Math.random() * 60) + 2;
                            });
                        }
                    });
                } else {
                    state = {
                        seasons: {},
                        currentSeasonId: null
                    };
                }
            };

            const getCurrentSeason = () => state.currentSeasonId ? state.seasons[state.currentSeasonId] : null;

            const render = () => {
                const currentSeason = getCurrentSeason();
                if (currentSeason) {
                    document.getElementById('selecao-temporada-view').classList.add('hidden');
                    document.getElementById('dashboard-temporada-view').classList.remove('hidden');
                    document.getElementById('temporada-nome').textContent = currentSeason.nome;
                    renderDashboard();
                    renderCalendario();
                    renderClassificacao();
                    renderNoticias();
                    renderAdminPage();
                } else {
                    document.getElementById('dashboard-temporada-view').classList.add('hidden');
                    document.getElementById('selecao-temporada-view').classList.remove('hidden');
                    renderListaTemporadas();
                }
            };

            const renderListaTemporadas = () => {
                const lista = document.getElementById('lista-temporadas');
                const seasonIds = Object.keys(state.seasons);
                if (seasonIds.length === 0) {
                    lista.innerHTML = '<p>Nenhuma temporada criada.</p>';
                    return;
                }
                lista.innerHTML = '<h3>Selecione uma Temporada</h3>';
                seasonIds.forEach(id => {
                    const season = state.seasons[id];
                    lista.innerHTML += `
                        <div class="lista-item" style="cursor:pointer;" data-action="select-season" data-id="${id}">
                            <div class="item-info"><p>${season.nome}</p></div>
                            <button class="action-btn" data-action="delete-season" data-id="${id}">üóëÔ∏è</button>
                        </div>
                    `;
                });
            };

            const renderDashboard = () => {
                const season = getCurrentSeason();
                if (!season) return;

                const renderMiniLista = (containerId, items, renderFn) => {
                    const container = document.getElementById(containerId);
                    if(!items || items.length === 0) {
                        container.innerHTML = '<p>Nenhum item.</p>';
                        return;
                    }
                    container.innerHTML = '';
                    items.forEach(item => container.innerHTML += renderFn(item));
                };

                renderMiniLista('dashboard-lista-equipes', season.equipes, (e) => `
                    <div class="lista-item"><div class="item-cor" style="background-color: ${e.cor};"></div><p>${e.nome}</p></div>`);
                
                renderMiniLista('dashboard-lista-pilotos', season.pilotos, (p) => {
                    const equipe = season.equipes.find(e => e.id === p.equipeId);
                    return `<div class="lista-item"><div class="item-cor" style="background-color: ${equipe?.cor || '#ccc'};"></div><p>${p.nome}</p></div>`;
                });

                // Safe check para noticias
                const noticiasSeguras = Array.isArray(season.noticias) ? season.noticias : [];
                const ultimasNoticias = [...noticiasSeguras].sort((a, b) => b.data - a.data).slice(0, 3);
                
                renderMiniLista('dashboard-lista-noticias', ultimasNoticias, (n) => `
    <div class="lista-item dashboard-noticia-preview" style="cursor:pointer;align-items:flex-start;" data-action="goto-noticias">
        ${n.imgUrl ? `<img src="${n.imgUrl}" alt="Imagem" style="width:56px;height:56px;object-fit:cover;border-radius:10px;margin-right:12px;">` : ''}
        <div class="item-info" style="flex:1;">
            <p style="font-weight:bold;margin-bottom:2px;">${n.titulo}</p>
            <span style="font-size:0.8rem;color:#888;">${new Date(n.data).toLocaleDateString()}</span>
            <div style="font-size:0.95rem;color:#444;margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px;">
                ${n.conteudo.replace(/<[^>]+>/g, '').slice(0, 60)}${n.conteudo.length > 60 ? '...' : ''}
            </div>
        </div>
    </div>
`);
            };
            
            const renderCalendario = () => {
                const lista = document.getElementById('lista-corridas');
                const season = getCurrentSeason();
                if (!season) {
                    lista.innerHTML = '<p>Selecione uma temporada para ver o calend√°rio.</p>';
                    return;
                }
                lista.innerHTML = season.calendario.length ? '' : '<p>Nenhuma etapa no calend√°rio.</p>';
                [...season.calendario].sort((a,b) => a.id - b.id).forEach(c => {
                    lista.innerHTML += `
                        <div class="card">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div style="display: flex; align-items: center;">
                                    <img src="${c.bandeira || 'https://placehold.co/40x40/eee/ccc?text=?'}" alt="Bandeira" class="item-avatar" style="border-radius: 4px;">
                                    <div><p style="font-weight: bold;">${c.nome}</p><span class="status status-${c.status}">${c.status.toUpperCase()}</span></div>
                                </div>
                                <div class="action-buttons">
                                    <button class="action-btn" data-action="edit-corrida" data-id="${c.id}">‚úèÔ∏è</button>
                                    <button class="action-btn" data-action="delete" data-id="${c.id}" data-tipo="corrida">üóëÔ∏è</button>
                                </div>
                            </div>
                            <div style="margin-top: 10px; display:flex; gap: 10px;">
                                ${c.status === 'finalizada' ? 
                                    `<button class="btn btn-secundario" data-action="ver-resultados" data-id="${c.id}">Ver Resultados</button>` :
                                    `<button class="btn btn-principal" data-action="lancar-resultados" data-id="${c.id}">Lan√ßar Resultados</button>`
                                }
                            </div>
                        </div>`;
                });
            };

            const renderClassificacao = () => {
                const season = getCurrentSeason();
                if (!season) return;

                const separarSprint = season.separarSprint;
                const tabSprintBtn = document.getElementById('tab-btn-sprint');
                
                // Controle da aba Sprint
                if (separarSprint) {
                    tabSprintBtn.classList.remove('hidden');
                } else {
                    tabSprintBtn.classList.add('hidden');
                    // Se estava na aba sprint e desativou, volta pra pilotos
                    if(document.getElementById('tab-sprint').classList.contains('active')){
                         document.querySelector('[data-tab="pilotos"]').click();
                    }
                }

                // Fun√ß√£o auxiliar para renderizar tabela
                const renderTableRows = (pilotosList, type) => {
                    return pilotosList.map((p, index) => {
                        const equipe = season.equipes.find(e => e.id === p.equipeId);
                        const pontosExibidos = type === 'total' ? p.pontos : 
                                               type === 'principal' ? p.pontosPrincipal : 
                                               p.pontosSprint;
                        
                        return `<tr data-action="ver-piloto" data-id="${p.id}" style="cursor: pointer;">
                            <td class="pos">${index + 1}</td>
                            <td>
                                <div class="piloto-info">
                                    <div class="item-cor" style="background-color: ${equipe?.cor || '#ccc'}"></div>
                                    <img src="${p.img || 'https://placehold.co/40x40/eee/ccc?text=?'}" alt="${p.nome}">
                                    <span>${p.nome}</span>
                                </div>
                            </td>
                            <td style="font-weight: bold; text-align: right;">${pontosExibidos}</td></tr>`;
                    }).join('');
                };

                // --- TABELA PRINCIPAL (PILOTOS) ---
                // Se separado: ordena por pontosPrincipal. Se junto: ordena por pontos (total)
                const pilotosPrincipal = [...season.pilotos].sort((a,b) => {
                    const pA = separarSprint ? a.pontosPrincipal : a.pontos;
                    const pB = separarSprint ? b.pontosPrincipal : b.pontos;
                    return pB - pA;
                });
                document.getElementById('tabela-pilotos').innerHTML = renderTableRows(pilotosPrincipal, separarSprint ? 'principal' : 'total');

                // --- TABELA SPRINT (PILOTOS) ---
                if (separarSprint) {
                    const pilotosSprint = [...season.pilotos].sort((a,b) => b.pontosSprint - a.pontosSprint);
                    document.getElementById('tabela-sprint-pilotos').innerHTML = renderTableRows(pilotosSprint, 'sprint');
                    
                    // Equipes Sprint
                     const pontosEquipesSprint = season.equipes.map(eq => ({
                        ...eq,
                        ptsSprint: season.pilotos.filter(p => p.equipeId === eq.id).reduce((acc, p) => acc + p.pontosSprint, 0)
                    })).sort((a,b) => b.ptsSprint - a.ptsSprint);

                    document.getElementById('tabela-sprint-equipes').innerHTML = pontosEquipesSprint.map((eq, index) => `
                     <tr data-action="ver-equipe" data-id="${eq.id}" style="cursor: pointer;">
                        <td class="pos">${index + 1}</td>
                        <td><div class="piloto-info"><img src="${eq.logo}" class="item-avatar"><span>${eq.nome}</span></div></td>
                        <td style="font-weight: bold; text-align: right;">${eq.ptsSprint}</td></tr>`).join('');
                }

                // --- TABELA EQUIPES (PRINCIPAL) ---
                const pontosEquipes = season.equipes.map(eq => ({
                    ...eq,
                    // Se separado, conta s√≥ os pontos principais para a tabela principal de construtores
                    pts: season.pilotos.filter(p => p.equipeId === eq.id).reduce((acc, p) => acc + (separarSprint ? p.pontosPrincipal : p.pontos), 0)
                })).sort((a,b) => b.pts - a.pts);
                
                document.getElementById('tabela-equipes').innerHTML = pontosEquipes.map((eq, index) => `
                     <tr data-action="ver-equipe" data-id="${eq.id}" style="cursor: pointer;">
                        <td class="pos">${index + 1}</td>
                        <td><div class="piloto-info"><img src="${eq.logo}" class="item-avatar"><span>${eq.nome}</span></div></td>
                        <td style="font-weight: bold; text-align: right;">${eq.pts}</td></tr>`).join('');

                // --- TABELA F√ÉS ---
                const fasOrdenados = [...season.pilotos].sort((a,b) => b.fas - a.fas);
                document.getElementById('tabela-fas').innerHTML = fasOrdenados.map((p, index) => {
                    const equipe = season.equipes.find(e => e.id === p.equipeId);
                    return `<tr data-action="ver-piloto" data-id="${p.id}" style="cursor: pointer;">
                        <td class="pos">${index + 1}</td>
                        <td>
                            <div class="piloto-info">
                                <div class="item-cor" style="background-color: ${equipe?.cor || '#ccc'}"></div>
                                <img src="${p.img || 'https://placehold.co/40x40/eee/ccc?text=?'}" alt="${p.nome}">
                                <span>${p.nome}</span>
                            </div>
                        </td>
                        <td style="font-weight: bold; text-align: right;">${p.fas.toLocaleString('pt-BR')}</td></tr>`;
                }).join('');
            };

            const renderNoticias = () => {
                const lista = document.getElementById('lista-noticias');
                const season = getCurrentSeason();
                if (!season) {
                    lista.innerHTML = '<p>Selecione uma temporada para ver as not√≠cias.</p>';
                    return;
                }
                
                if (!season.noticias || !Array.isArray(season.noticias) || season.noticias.length === 0) {
                     lista.innerHTML = '<p>Nenhuma not√≠cia publicada.</p>';
                     return;
                }

                lista.innerHTML = '';
                // Ordenar e renderizar
                [...season.noticias].sort((a, b) => b.data - a.data).forEach(n => {
                    const pilotos = n.pilotosMarcados?.map(pid => season.pilotos.find(p => p.id == pid)?.nome).filter(Boolean).join(', ');
                    const equipes = n.equipesMarcadas?.map(eid => season.equipes.find(e => e.id == eid)?.nome).filter(Boolean).join(', ');
                    
                    // Sistema Fake de Social
                    const likes = n.likes ? n.likes.toLocaleString('pt-BR') : '0';
                    const comments = n.comentarios ? n.comentarios : '0';

                    lista.innerHTML += `
                        <div class="card">
                            <div style="display:flex; justify-content: space-between; align-items: start;">
                                <div><h4>${n.titulo}</h4><p style="font-size: 0.8rem; color: #555; margin-bottom: 10px;">${new Date(n.data).toLocaleDateString()}</p></div>
                                <button class="action-btn" data-action="delete" data-id="${n.id}" data-tipo="noticia">üóëÔ∏è</button>
                            </div>
                            ${n.imgUrl ? `<img src="${n.imgUrl}" class="noticia-img" alt="Imagem da not√≠cia">` : ''}
                            <p>${n.conteudo}</p>
                            ${pilotos ? `<p style="font-size: 0.8rem; color: #888; margin-top: 10px;"><i>Pilotos: ${pilotos}</i></p>` : ''}
                            ${equipes ? `<p style="font-size: 0.8rem; color: #888; margin-top: 5px;"><i>Equipes: ${equipes}</i></p>` : ''}
                            
                            <div class="social-stats">
                                <span>‚ù§Ô∏è ${likes} Curtidas</span>
                                <span>üí¨ ${comments} Coment√°rios</span>
                                <span style="margin-left:auto;">üîó Compartilhar</span>
                            </div>
                        </div>`;
                });
            };

            const renderAdminPage = () => {
                const season = getCurrentSeason();
                if (!season) return;
                
                document.getElementById('check-separar-sprint').checked = season.separarSprint;

                const renderPontosInputs = (tipo) => {
                    const container = document.getElementById(`pontos-${tipo}-container`);
                    const pontos = season.pontuacao[tipo];
                    container.innerHTML = '';
                    Object.keys(pontos).sort((a, b) => a - b).forEach(pos => {
                        container.innerHTML += `<div class="input-group" style="display: flex; align-items: center; gap: 10px;"><label style="flex-basis: 60px;">${pos}¬∫:</label><input type="number" value="${pontos[pos]}" data-tipo="${tipo}" data-pos="${pos}" class="ponto-input" style="flex-grow: 1;"><button type="button" class="btn-remove-pos" data-tipo="${tipo}" data-pos="${pos}">X</button></div>`;
                    });
                };
                renderPontosInputs('corrida');
                renderPontosInputs('sprint');
                renderPontosInputs('quali');
                document.getElementById('ponto-volta-rapida').value = season.pontuacao.voltaRapida;
            };

            const showModal = (content) => {
                document.getElementById('modal-content').innerHTML = content;
                document.getElementById('modal-backdrop').classList.add('visible');
            };
            const hideModal = () => document.getElementById('modal-backdrop').classList.remove('visible');
            window.hideModal = hideModal;
            
            const calcularPontosTotais = () => {
                const season = getCurrentSeason();
                if (!season) return;
                
                // Resetar pontos
                season.pilotos.forEach(p => { 
                    p.pontos = 0; 
                    p.pontosSprint = 0; 
                    p.pontosPrincipal = 0; 
                });

                season.calendario.forEach(corrida => {
                    if (corrida.status === 'finalizada' && corrida.resultados) {
                        const res = corrida.resultados;
                        const getPiloto = id => season.pilotos.find(p => p.id == id);
                        
                        // Pontos Principal (Quali + Corrida + Volta)
                        Object.entries(res.quali).forEach(([pos, pId]) => { 
                            const p = getPiloto(pId); 
                            if (p) p.pontosPrincipal += (season.pontuacao.quali[pos] || 0); 
                        });
                        Object.entries(res.corrida).forEach(([pos, pId]) => { 
                            const p = getPiloto(pId); 
                            if (p && pId !== 'DNF') p.pontosPrincipal += (season.pontuacao.corrida[pos] || 0); 
                        });
                        if(res.voltaRapida) { 
                            const p = getPiloto(res.voltaRapida); 
                            if(p) p.pontosPrincipal += (season.pontuacao.voltaRapida || 0); 
                        }

                        // Pontos Sprint (Separado)
                        Object.entries(res.sprint).forEach(([pos, pId]) => { 
                            const p = getPiloto(pId); 
                            if (p && pId !== 'DNF') p.pontosSprint += (season.pontuacao.sprint[pos] || 0); 
                        });
                    }
                });

                // Soma total (para compatibilidade ou visualiza√ß√£o total)
                season.pilotos.forEach(p => {
                    p.pontos = p.pontosPrincipal + p.pontosSprint;
                });
            };

            const atualizarFasEReputacao = (resultados, noticia = null) => {
                const season = getCurrentSeason();
                if (!season) return;
                const totalPilotos = season.pilotos.length;
                if (totalPilotos === 0) return;

                // Impacto por resultado de corrida
                if(resultados) {
                    season.pilotos.forEach(piloto => {
                        const posCorrida = Object.keys(resultados.corrida).find(pos => resultados.corrida[pos] == piloto.id);
                        if (posCorrida && resultados.corrida[posCorrida] !== 'DNF') {
                            piloto.fas += Math.floor((totalPilotos - parseInt(posCorrida) + 1) * 50 * (Math.random() * 0.5 + 0.8));
                        } else {
                            piloto.fas -= Math.floor(Math.random() * 50); 
                        }
                    });
                }

                // Impacto por not√≠cia
                if (noticia) {
                    const { impacto, pilotosMarcados } = noticia;
                    const fanChange = { 'positivo': 500, 'neutro': 50, 'negativo': -350 };
                    pilotosMarcados.forEach(pId => {
                        const piloto = season.pilotos.find(p => p.id == pId);
                        if (piloto) piloto.fas += fanChange[impacto];
                    });
                }

                // Garantir que f√£s n√£o sejam negativos
                season.pilotos.forEach(piloto => {
                    if (piloto.fas < 0) piloto.fas = 0;
                });

                // Recalcular Reputa√ß√£o
                const pilotosOrdenados = [...season.pilotos].sort((a, b) => b.pontos - a.pontos);
                const rankingPilotos = {};
                pilotosOrdenados.forEach((p, i) => rankingPilotos[p.id] = i + 1);
                
                const pontosEquipes = season.equipes.map(eq => ({
                    id: eq.id,
                    pontos: season.pilotos.filter(p => p.equipeId === eq.id).reduce((acc, p) => acc + p.pontos, 0)
                })).sort((a,b) => b.pontos - a.pontos);
                const rankingEquipes = {};
                pontosEquipes.forEach((eq, i) => rankingEquipes[eq.id] = i + 1);

                season.pilotos.forEach(piloto => {
                    const rankPiloto = rankingPilotos[piloto.id];
                    const rankEquipe = rankingEquipes[piloto.equipeId];
                    if (!rankPiloto || !rankEquipe) {
                        piloto.reputacao = 5.0; 
                        return;
                    }
                    
                    let reputacaoBase = totalPilotos > 1 ? ((totalPilotos - rankPiloto) / (totalPilotos - 1)) * 10 : 10;
                    const expectativaEquipe = pontosEquipes.length > 1 ? ((pontosEquipes.length - rankEquipe) / (pontosEquipes.length - 1)) : 1;
                    const diff = reputacaoBase - (expectativaEquipe * 10);
                    let reputacaoFinal = reputacaoBase + (diff / 2);
                    
                    piloto.reputacao = Math.max(0, Math.min(10, reputacaoFinal));
                });
            };

            // --- Event Listeners ---
            document.querySelector('nav').addEventListener('click', (e) => {
                const button = e.target.closest('.nav-button');
                if (button) {
                    const pageId = `page-${button.dataset.page}`;
                    
                    // Bugfix preventivo ao trocar de p√°gina
                    if(pageId === 'page-noticias') {
                        const season = getCurrentSeason();
                        if(!season.noticias) season.noticias = [];
                        renderNoticias();
                    }

                    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                    document.getElementById(pageId).classList.add('active');
                    document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
                    button.classList.add('active');
                }
            });

            const tabsContainer = document.querySelector('#page-classificacao .tabs');
            if(tabsContainer) {
                tabsContainer.addEventListener('click', e => {
                    if (e.target.classList.contains('tab-button')) {
                        const tabId = `tab-${e.target.dataset.tab}`;
                        document.querySelectorAll('#page-classificacao .tab-button').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        document.querySelectorAll('#page-classificacao .tab-content').forEach(c => c.classList.remove('active'));
                        document.getElementById(tabId).classList.add('active');
                    }
                });
            }

            document.getElementById('btn-nova-temporada').addEventListener('click', () => {
                const nome = prompt('Digite o nome da nova temporada:', `Temporada ${new Date().getFullYear()}`);
                if (nome) {
                    const novaTemporada = createNewSeason(nome);
                    state.seasons[novaTemporada.id] = novaTemporada;
                    state.currentSeasonId = novaTemporada.id;
                    saveState();
                    render();
                }
            });

            document.getElementById('btn-mudar-temporada').addEventListener('click', () => {
                state.currentSeasonId = null;
                saveState();
                render();
            });

            // Listener Admin Reparos
            document.getElementById('check-separar-sprint').addEventListener('change', (e) => {
                const season = getCurrentSeason();
                if(season) {
                    season.separarSprint = e.target.checked;
                    calcularPontosTotais(); // Recalcula pra garantir
                    saveState();
                    renderClassificacao(); // Atualiza a tela de classifica√ß√£o
                    alert('Configura√ß√£o salva! Verifique a aba de Classifica√ß√£o.');
                }
            });

            document.getElementById('btn-fix-noticias').addEventListener('click', () => {
                const season = getCurrentSeason();
                if(season) {
                    if (confirm('Isso vai limpar qualquer not√≠cia corrompida que esteja travando o app. Deseja continuar?')) {
                        if (!Array.isArray(season.noticias)) season.noticias = [];
                        // Filtra apenas not√≠cias v√°lidas
                        season.noticias = season.noticias.filter(n => n && n.id && n.titulo);
                        saveState();
                        render();
                        alert('Corre√ß√£o aplicada! Tente acessar a aba Not√≠cias agora.');
                    }
                }
            });

            document.getElementById('main-content').addEventListener('click', e => {
                const actionBtn = e.target.closest('[data-action]');
                if (!actionBtn) return;

                const { action, id } = actionBtn.dataset;
                const season = getCurrentSeason();

                switch(action) {
                    case 'select-season': state.currentSeasonId = id; saveState(); render(); break;
                    case 'delete-season':
                        if (confirm(`Tem certeza que deseja apagar a temporada "${state.seasons[id].nome}"? A a√ß√£o n√£o pode ser desfeita.`)) {
                            delete state.seasons[id];
                            if (state.currentSeasonId == id) state.currentSeasonId = null;
                            saveState(); render();
                        }
                        break;
                    case 'delete':
                        const { tipo } = actionBtn.dataset;
                        if (confirm(`Tem certeza que deseja remover este item (${tipo})?`)) {
                            if (tipo === 'equipe') {
                                season.equipes = season.equipes.filter(item => item.id != id);
                                season.pilotos.forEach(p => { if (p.equipeId == id) p.equipeId = null; });
                            }
                            if (tipo === 'piloto') season.pilotos = season.pilotos.filter(item => item.id != id);
                            if (tipo === 'corrida') season.calendario = season.calendario.filter(item => item.id != id);
                            if (tipo === 'noticia') season.noticias = season.noticias.filter(item => item.id != id);
                            saveState(); render();
                        }
                        break;
                    case 'add-equipe': showEditEquipeModal(); break;
                    case 'add-piloto': showEditPilotoModal(); break;
                    case 'add-corrida': showEditCorridaModal(); break;
                    case 'add-noticia': showEditNoticiaModal(); break;
                    case 'edit-equipe': showEditEquipeModal(id); break;
                    case 'edit-piloto': showEditPilotoModal(id); break;
                    case 'edit-corrida': showEditCorridaModal(id); break;
                    case 'lancar-resultados': showResultadosModal(id); break;
                    case 'ver-resultados': showVerResultadosModal(id); break;
                    case 'ver-piloto': showVerPilotoModal(id); break;
                    case 'ver-equipe': showVerEquipeModal(id); break;
                    case 'goto-noticias': document.querySelector('[data-page="noticias"]').click(); break;
                }
            });
            
            function showEditEquipeModal(id = null) {
                const season = getCurrentSeason();
                const equipe = id ? season.equipes.find(e => e.id == id) : null;
                showModal(`<h3>${equipe ? 'Editar' : 'Adicionar'} Equipe</h3><form id="form-edit-equipe" data-id="${id || ''}"><div class="input-group"><label>Nome</label><input type="text" id="equipe-nome" value="${equipe?.nome || ''}" required></div><div class="input-group"><label>URL do Logo</label><input type="url" id="equipe-logo" value="${equipe?.logo || ''}" placeholder="https://..." required></div><div class="input-group"><label>Cor</label><input type="color" id="equipe-cor" value="${equipe?.cor || '#ff0000'}"></div><button type="submit" class="btn btn-principal">Salvar</button></form>`);
            }
            window.showEditEquipeModal = showEditEquipeModal;

            function showEditPilotoModal(id = null) {
                const season = getCurrentSeason();
                if (season.equipes.length === 0) { alert('Adicione uma equipe primeiro.'); return; }
                const piloto = id ? season.pilotos.find(p => p.id == id) : null;
                const options = season.equipes.map(e => `<option value="${e.id}" ${piloto?.equipeId == e.id ? 'selected' : ''}>${e.nome}</option>`).join('');
                showModal(`<h3>${piloto ? 'Editar' : 'Adicionar'} Piloto</h3><form id="form-edit-piloto" data-id="${id || ''}"><div class="input-group"><label>Nome</label><input type="text" id="piloto-nome" value="${piloto?.nome || ''}" required></div><div class="input-group"><label>URL da Imagem</label><input type="url" id="piloto-img" value="${piloto?.img || ''}" placeholder="https://..."></div><div class="input-group"><label>Equipe</label><select id="piloto-equipe" required>${options}</select></div><button type="submit" class="btn btn-principal">Salvar</button></form>`);
            }
            window.showEditPilotoModal = showEditPilotoModal;

            window.deletePiloto = function(id) {
                const season = getCurrentSeason();
                if (!season) return;
                season.pilotos = season.pilotos.filter(p => p.id != id);
                saveState();
                render();
            };
            window.deleteEquipe = function(id) {
                const season = getCurrentSeason();
                if (!season) return;
                season.equipes = season.equipes.filter(e => e.id != id);
                // Remove equipe dos pilotos
                season.pilotos.forEach(p => { if (p.equipeId == id) p.equipeId = null; });
                saveState();
                render();
            };

            function showEditCorridaModal(id = null) {
                const season = getCurrentSeason();
                const corrida = id ? season.calendario.find(c => c.id == id) : null;
                let resultadosHtml = '';
                if (corrida && corrida.status === 'finalizada' && corrida.resultados) {
                    const pilotoOptions = season.pilotos.map(p => `<option value="${p.id}">${p.nome}</option>`).join('');
                    // Grid
                    resultadosHtml += `<h4 style="margin-top:20px;">Grid de Largada</h4>`;
                    Object.keys(corrida.resultados.grid).forEach(pos => {
                        resultadosHtml += `<div class="input-group"><label>${pos}¬∫</label>
                            <select class="grid-pos" data-pos="${pos}">
                                <option value="">--</option>
                                ${pilotoOptions.replace(`value="${corrida.resultados.grid[pos]}"`, `value="${corrida.resultados.grid[pos]}" selected`)}
                            </select>
                        </div>`;
                    });
                    // Quali
                    resultadosHtml += `<h4 style="margin-top:20px;">Qualifica√ß√£o</h4>`;
                    Object.keys(corrida.resultados.quali).forEach(pos => {
                        resultadosHtml += `<div class="input-group"><label>${pos}¬∫</label>
                            <select class="quali-pos" data-pos="${pos}">
                                <option value="">--</option>
                                ${pilotoOptions.replace(`value="${corrida.resultados.quali[pos]}"`, `value="${corrida.resultados.quali[pos]}" selected`)}
                            </select>
                        </div>`;
                    });
                    // Corrida
                    resultadosHtml += `<h4 style="margin-top:20px;">Corrida</h4>`;
                    Object.keys(corrida.resultados.corrida).forEach(pos => {
                        const valor = corrida.resultados.corrida[pos];
                        resultadosHtml += `<div class="input-group"><label>${pos}¬∫</label>
                            <select class="corrida-pos" data-pos="${pos}">
                                <option value="">--</option>
                                ${pilotoOptions.replace(`value="${valor}"`, `value="${valor}" selected`)}
                                <option value="DNF"${valor === 'DNF' ? ' selected' : ''}>DNF</option>
                            </select>
                            ${valor === 'DNF' ? `
                                <select class="corrida-dnf-piloto" data-pos="${pos}">
                                    <option value="">Selecione o piloto DNF</option>
                                    ${pilotoOptions.replace(`value="${corrida.resultados.corrida['dnf_'+pos] || ''}"`, `value="${corrida.resultados.corrida['dnf_'+pos] || ''}" selected`)}
                                </select>
                            ` : ''}
                        </div>`;
                    });
                    // Sprint
                    resultadosHtml += `<h4 style="margin-top:20px;">Sprint</h4>`;
                    Object.keys(corrida.resultados.sprint).forEach(pos => {
                        const valor = corrida.resultados.sprint[pos];
                        resultadosHtml += `<div class="input-group"><label>${pos}¬∫</label>
                            <select class="sprint-pos" data-pos="${pos}">
                                <option value="">--</option>
                                ${pilotoOptions.replace(`value="${valor}"`, `value="${valor}" selected`)}
                                <option value="DNF"${valor === 'DNF' ? ' selected' : ''}>DNF</option>
                            </select>
                            ${valor === 'DNF' ? `
                                <select class="sprint-dnf-piloto" data-pos="${pos}">
                                    <option value="">Selecione o piloto DNF</option>
                                    ${pilotoOptions.replace(`value="${corrida.resultados.sprint['dnf_'+pos] || ''}"`, `value="${corrida.resultados.sprint['dnf_'+pos] || ''}" selected`)}
                                </select>
                            ` : ''}
                        </div>`;
                    });
                    // Volta R√°pida
                    resultadosHtml += `<h4 style="margin-top:20px;">Volta R√°pida</h4>
                        <div class="input-group">
                            <select id="volta-rapida">
                                <option value="">--</option>
                                ${pilotoOptions.replace(`value="${corrida.resultados.voltaRapida}"`, `value="${corrida.resultados.voltaRapida}" selected`)}
                            </select>
                        </div>`;
             }

                    showModal(`<h3>${corrida ? 'Editar' : 'Adicionar'} Etapa</h3>
                        <form id="form-edit-corrida" data-id="${id || ''}">
                            <div class="input-group"><label>Nome</label><input type="text" id="corrida-nome-edit" value="${corrida?.nome || ''}" required></div>
                            <div class="input-group"><label>URL da Bandeira</label><input type="url" id="corrida-bandeira-edit" value="${corrida?.bandeira || ''}" placeholder="https://..."></div>
                            ${resultadosHtml}
                            <button type="submit" class="btn btn-principal">Salvar</button>
                        </form>`);
                }

            function showEditNoticiaModal() {
                const season = getCurrentSeason();
                const pilotosOptions = season.pilotos.map(p => `<option value="${p.id}">${p.nome}</option>`).join('');
                const equipesOptions = season.equipes.map(e => `<option value="${e.id}">${e.nome}</option>`).join('');
                showModal(`<h3>Publicar Not√≠cia</h3><form id="form-add-noticia"><div class="input-group"><label>T√≠tulo</label><input type="text" id="noticia-titulo" required></div><div class="input-group"><label>URL da Imagem</label><input type="url" id="noticia-img" placeholder="https://..."></div><div class="input-group"><label>Conte√∫do</label><textarea id="noticia-conteudo" rows="4" required></textarea></div><div class="input-group"><label>Impacto da Not√≠cia</label><select id="noticia-impacto"><option value="positivo">Positivo</option><option value="neutro" selected>Neutro</option><option value="negativo">Negativo</option></select></div><div class="input-group"><label>Marcar Pilotos</label><select id="noticia-pilotos" multiple>${pilotosOptions}</select></div><div class="input-group"><label>Marcar Equipes</label><select id="noticia-equipes" multiple>${equipesOptions}</select></div><button type="submit" class="btn btn-principal">Publicar</button></form>`);
            }

            function showResultadosModal(id) {
                const season = getCurrentSeason();
                const corrida = season.calendario.find(c => c.id == id);
                const pilotoOptions = season.pilotos.map(p => `<option value="${p.id}">${p.nome}</option>`).join('');
                const createSelects = (type) => [...Array(season.pilotos.length)].map((_, i) => `<div class="input-group"><label>${i+1}¬∫ Lugar</label><select class="${type}-pos" data-pos="${i+1}"><option value="">--</option>${pilotoOptions}</select></div>`).join('');
                const createRaceSelects = () => [...Array(season.pilotos.length)].map((_, i) => `<div class="input-group"><label>${i+1}¬∫ Lugar</label><select class="corrida-pos" data-pos="${i+1}"><option value="">--</option>${pilotoOptions}<option value="DNF">DNF</option></select></div>`).join('');
                showModal(`<h3>Resultados para ${corrida.nome}</h3><form id="form-resultados" data-id="${id}"><h4>Grid de Largada</h4>${createSelects('grid')}<hr style="margin:20px 0"><h4>Qualifica√ß√£o</h4>${Object.keys(season.pontuacao.quali).map(pos => `<div class="input-group"><label>${pos}¬∫</label><select class="quali-pos" data-pos="${pos}"><option value="">--</option>${pilotoOptions}</select></div>`).join('')}<hr style="margin:20px 0"><h4>Sprint</h4>${createSelects('sprint')}<hr style="margin:20px 0"><h4>Corrida</h4>${createRaceSelects()}<hr style="margin:20px 0"><h4>Volta R√°pida</h4><div class="input-group"><select id="volta-rapida"><option value="">--</option>${pilotoOptions}</select></div><br><button type="submit" class="btn btn-sucesso">Salvar</button></form>`);
            }

            function showVerResultadosModal(id) {
                 const season = getCurrentSeason();
                 const corrida = season.calendario.find(c => c.id == id);
                 const res = corrida.resultados;
                 const getNome = (pId) => season.pilotos.find(p => p.id == pId)?.nome || 'N/A';
                 const getPontosPilotoNaCorrida = (pilotoId) => {
                    let pontos = 0;
                    Object.entries(res.quali).forEach(([pos, pId]) => { if(pId == pilotoId) pontos += (season.pontuacao.quali[pos] || 0); });
                    const sprintPos = Object.keys(res.sprint).find(pos => res.sprint[pos] == pilotoId);
                    if (sprintPos) pontos += (season.pontuacao.sprint[sprintPos] || 0);
                    const racePos = Object.keys(res.corrida).find(pos => res.corrida[pos] == pilotoId);
                    if (racePos && res.corrida[racePos] !== 'DNF') pontos += (season.pontuacao.corrida[racePos] || 0);
                    if(res.voltaRapida == pilotoId) pontos += season.pontuacao.voltaRapida;
                    return pontos;
                 };
                 
                 let html = `<h3>Resultados - ${corrida.nome}</h3>`;
                 html += `<h4>Corrida Principal</h4>` + Object.entries(res.corrida).sort((a,b) => a[0] - b[0]).map(([pos, pId]) => {
                    if (pId === 'DNF') {
                        const dnfPilotoId = res.corrida['dnf_'+pos];
                        return `<p>${pos}¬∫: DNF (${getNome(dnfPilotoId)})</p>`;
                    }
                    return `<p>${pos}¬∫: ${getNome(pId)} <strong>(+${getPontosPilotoNaCorrida(pId)} pts)</strong></p>`;
                }).join('');
                 if (Object.keys(res.sprint).length > 0) html += `<h4 style="margin-top:15px;">Sprint</h4>` + Object.entries(res.sprint).sort((a,b) => a[0] - b[0]).map(([pos, pId]) => `<p>${pos}¬∫: ${getNome(pId)}</p>`).join('');
                 html += `<h4 style="margin-top:15px;">Qualifica√ß√£o</h4>` + Object.entries(res.quali).sort((a,b) => a[0] - b[0]).map(([pos, pId]) => `<p>${pos}¬∫: ${getNome(pId)}</p>`).join('');
                 if (res.voltaRapida) html += `<p style="margin-top:10px;"><strong>Volta R√°pida:</strong> ${getNome(res.voltaRapida)}</p>`;
                 html += `<br><button onclick="hideModal()" class="btn btn-secundario">Fechar</button>`;
                 showModal(html);
            }

            function showVerPilotoModal(id) {
                const season = getCurrentSeason();
                const piloto = season.pilotos.find(p => p.id == id);
                const equipe = season.equipes.find(e => e.id == piloto.equipeId);
                const rank = [...season.pilotos].sort((a,b) => b.pontos - a.pontos).findIndex(p => p.id == id) + 1;
                let qualiPos = [], racePos = [];
                season.calendario.filter(c => c.status === 'finalizada' && c.resultados).forEach(c => {
                    const qp = Object.keys(c.resultados.quali).find(pos => c.resultados.quali[pos] == id);
                    const rp = Object.keys(c.resultados.corrida).find(pos => c.resultados.corrida[pos] == id);
                    if (qp) qualiPos.push(parseInt(qp));
                    if (rp) racePos.push(parseInt(rp));
                });
                const avgQuali = qualiPos.length ? (qualiPos.reduce((a,b) => a+b, 0) / qualiPos.length).toFixed(1) : 'N/A';
                const avgRace = racePos.length ? (racePos.reduce((a,b) => a+b, 0) / racePos.length).toFixed(1) : 'N/A';
                
                // Exibi√ß√£o condicional de pontos se a sprint estiver separada
                const pontosDetail = season.separarSprint 
                    ? `<p><strong>Pontos Totais:</strong> ${piloto.pontos} <span style="font-size:0.8rem">(${piloto.pontosPrincipal} Princ. + ${piloto.pontosSprint} Sprint)</span></p>`
                    : `<p><strong>Pontos:</strong> ${piloto.pontos}</p>`;

                showModal(`
        <div style="text-align:center;">
            <img src="${piloto.img || 'https://placehold.co/80x80/eee/ccc?text=?'}" class="item-avatar" style="width:80px;height:80px;margin-bottom:10px;">
            <h2>${piloto.nome}</h2>
            <p style="font-size:1.1rem;color:#555;">${equipe?.nome || 'Sem equipe'}</p>
        </div>
        <div style="margin-top:20px;">
            <p><strong>Posi√ß√£o Geral:</strong> ${rank}¬∫</p>
            ${pontosDetail}
            <p><strong>Pos. M√©dia Quali:</strong> ${avgQuali}</p>
            <p><strong>Pos. M√©dia Corrida:</strong> ${avgRace}</p>
            <p><strong>F√£s:</strong> ${piloto.fas.toLocaleString('pt-BR')}</p>
            <p><strong>Reputa√ß√£o:</strong> ${piloto.reputacao.toFixed(1)} / 10</p>
        </div>
        <br>
        <button onclick="hideModal()" class="btn btn-secundario">Fechar</button>
        <button onclick="showEditPilotoModal(${id})" class="btn btn-principal" style="margin-top:10px;">Editar</button>
        <button onclick="if(confirm('Excluir este piloto?')) { deletePiloto(${id}); hideModal(); }" class="btn btn-secundario" style="margin-top:10px;">Excluir</button>
    `);
            }
            function showVerEquipeModal(id) {
                const season = getCurrentSeason();
                const equipe = season.equipes.find(e => e.id == id);
                const pilotosDaEquipe = season.pilotos.filter(p => p.equipeId == id);
                const totalPontos = pilotosDaEquipe.reduce((acc, p) => acc + p.pontos, 0);
                showModal(`
        <div style="text-align:center;">
            <img src="${equipe.logo || 'https://placehold.co/80x80/eee/ccc?text=?'}" class="item-avatar" style="width:80px;height:80px;margin-bottom:10px;">
            <h2>${equipe.nome}</h2>
            <p style="font-size:1.2rem;font-weight:bold;">${totalPontos} Pontos Totais</p>
        </div>
        <div style="margin-top:20px;">
            <h3>Pilotos</h3>
            ${pilotosDaEquipe.map(p => `<div class="lista-item"><p>${p.nome}</p></div>`).join('') || '<p>Nenhum piloto.</p>'}
        </div>
        <br>
        <button onclick="hideModal()" class="btn btn-secundario">Fechar</button>
        <button onclick="showEditEquipeModal(${id})" class="btn btn-principal" style="margin-top:10px;">Editar</button>
        <button onclick="if(confirm('Excluir esta equipe?')) { deleteEquipe(${id}); hideModal(); }" class="btn btn-secundario" style="margin-top:10px;">Excluir</button>
    `);
            }

            document.getElementById('modal-backdrop').addEventListener('submit', (e) => {
                e.preventDefault();
                const form = e.target;
                const id = form.dataset.id;
                const season = getCurrentSeason();
                
                if (form.id === 'form-edit-equipe') {
                    const data = { nome: form.querySelector('#equipe-nome').value, logo: form.querySelector('#equipe-logo').value, cor: form.querySelector('#equipe-cor').value };
                    if (id) Object.assign(season.equipes.find(i => i.id == id), data);
                    else season.equipes.push({ id: Date.now(), ...data });
                }
                if (form.id === 'form-edit-piloto') {
                    const data = { nome: form.querySelector('#piloto-nome').value, img: form.querySelector('#piloto-img').value, equipeId: parseInt(form.querySelector('#piloto-equipe').value) };
                    if (id) Object.assign(season.pilotos.find(i => i.id == id), data);
                    else season.pilotos.push({ id: Date.now(), pontos: 0, fas: 1000, reputacao: 5.0, ...data });
                }
                if (form.id === 'form-edit-corrida') {
                    const data = { 
                        nome: form.querySelector('#corrida-nome-edit').value, 
                        bandeira: form.querySelector('#corrida-bandeira-edit').value 
                    };
                    if (id) {
                        const corrida = season.calendario.find(c => c.id == id);
                        Object.assign(corrida, data);
                        // Atualiza resultados se existirem campos de resultado
                        if (corrida.status === 'finalizada' && corrida.resultados) {
                            const resultados = { grid: {}, quali: {}, sprint: {}, corrida: {}, voltaRapida: null };
                            form.querySelectorAll('.grid-pos').forEach(s => { if (s.value) resultados.grid[s.dataset.pos] = s.value; });
                            form.querySelectorAll('.quali-pos').forEach(s => { if (s.value) resultados.quali[s.dataset.pos] = s.value; });
                            // Sprint
                            form.querySelectorAll('.sprint-pos').forEach(s => {
                                if (s.value === 'DNF') {
                                    const dnfPiloto = form.querySelector(`.sprint-dnf-piloto[data-pos="${s.dataset.pos}"]`)?.value;
                                    resultados.sprint[s.dataset.pos] = 'DNF';
                                    if (dnfPiloto) resultados.sprint['dnf_'+s.dataset.pos] = dnfPiloto;
                                } else if (s.value) {
                                    resultados.sprint[s.dataset.pos] = s.value;
                                }
                            });
                            // Corrida
                            form.querySelectorAll('.corrida-pos').forEach(s => {
                                if (s.value === 'DNF') {
                                    const dnfPiloto = form.querySelector(`.corrida-dnf-piloto[data-pos="${s.dataset.pos}"]`)?.value;
                                    resultados.corrida[s.dataset.pos] = 'DNF';
                                    if (dnfPiloto) resultados.corrida['dnf_'+s.dataset.pos] = dnfPiloto;
                                } else if (s.value) {
                                    resultados.corrida[s.dataset.pos] = s.value;
                                }
                            });
                            resultados.voltaRapida = form.querySelector('#volta-rapida')?.value || null;
                            corrida.resultados = resultados;
                            calcularPontosTotais();
                            atualizarFasEReputacao(resultados);
                        }
                    } else {
                        season.calendario.push({ id: Date.now(), status: 'espera', resultados: null, ...data });
                    }
                }
                if (form.id === 'form-add-noticia') {
                    const noticia = { 
                        id: Date.now(), 
                        titulo: form.querySelector('#noticia-titulo').value, 
                        conteudo: form.querySelector('#noticia-conteudo').value, 
                        imgUrl: form.querySelector('#noticia-img').value, 
                        impacto: form.querySelector('#noticia-impacto').value, 
                        pilotosMarcados: Array.from(form.querySelector('#noticia-pilotos').selectedOptions).map(o => o.value), 
                        equipesMarcadas: Array.from(form.querySelector('#noticia-equipes').selectedOptions).map(o => o.value), 
                        data: Date.now(),
                        // Fake social stats gerados na hora
                        likes: Math.floor(Math.random() * 500) + 10,
                        comentarios: Math.floor(Math.random() * 60) + 2
                    };
                    if(!season.noticias) season.noticias = [];
                    season.noticias.push(noticia);
                    atualizarFasEReputacao(null, noticia);
                }
                if (form.id === 'form-resultados') {
                    const corrida = season.calendario.find(c => c.id == id);
                    const resultados = { grid: {}, quali: {}, sprint: {}, corrida: {}, voltaRapida: null };
                    form.querySelectorAll('.grid-pos').forEach(s => { if (s.value) resultados.grid[s.dataset.pos] = s.value; });
                    form.querySelectorAll('.quali-pos').forEach(s => { if (s.value) resultados.quali[s.dataset.pos] = s.value; });
                    form.querySelectorAll('.sprint-pos').forEach(s => { if (s.value) resultados.sprint[s.dataset.pos] = s.value; });
                    form.querySelectorAll('.corrida-pos').forEach(s => { if (s.value) resultados.corrida[s.dataset.pos] = s.value; });
                    resultados.voltaRapida = form.querySelector('#volta-rapida').value || null;
                    corrida.resultados = resultados;
                    corrida.status = 'finalizada';
                    calcularPontosTotais();
                    atualizarFasEReputacao(resultados);
                }
                saveState();
                render();
                hideModal();
            });

            document.getElementById('form-pontuacao').addEventListener('submit', e => {
                e.preventDefault();
                const season = getCurrentSeason();
                document.querySelectorAll('.ponto-input').forEach(input => {
                    const { tipo, pos } = input.dataset;
                    season.pontuacao[tipo][pos] = parseInt(input.value) || 0;
                });
                season.pontuacao.voltaRapida = parseInt(document.getElementById('ponto-volta-rapida').value) || 0;
                calcularPontosTotais();
                saveState();
                render();
                alert('Sistema de pontua√ß√£o salvo!');
            });

            document.getElementById('page-admin').addEventListener('click', e => {
                const target = e.target;
                const season = getCurrentSeason();
                if(!season) return;
                if (target.classList.contains('btn-add-pos')) {
                    const { tipo } = target.dataset;
                    const nextPos = Object.keys(season.pontuacao[tipo]).length + 1;
                    season.pontuacao[tipo][nextPos] = 0;
                    renderAdminPage();
                }
                if (target.classList.contains('btn-remove-pos')) {
                    const { tipo, pos } = target.dataset;
                    delete season.pontuacao[tipo][pos];
                    renderAdminPage();
                }
            });
            
            document.getElementById('btn-ver-grafico').addEventListener('click', () => {
                const season = getCurrentSeason();
                const corridasFinalizadas = season.calendario.filter(c => c.status === 'finalizada').sort((a,b) => a.id - b.id);
                if (corridasFinalizadas.length < 1) { alert('√â necess√°rio ter pelo menos 1 corrida finalizada.'); return; }
                const labels = corridasFinalizadas.map(c => c.nome);
                const datasets = season.equipes.map(equipe => {
                    const data = [];
                    let pontosAcumulados = 0;
                    const pilotosDaEquipeIds = season.pilotos.filter(p => p.equipeId === equipe.id).map(p => p.id);
                    corridasFinalizadas.forEach(corrida => {
                        let pontosDaCorrida = 0;
                        pilotosDaEquipeIds.forEach(pilotoId => {
                            const res = corrida.resultados;
                            Object.entries(res.quali).forEach(([pos, pId]) => { if(pId == pilotoId) pontosDaCorrida += (season.pontuacao.quali[pos] || 0); });
                            const sprintPos = Object.keys(res.sprint).find(pos => res.sprint[pos] == pilotoId);
                            // IMPORTANTE: Aqui precisamos somar tudo para o gr√°fico total, 
                            // independente se a visualiza√ß√£o da tabela est√° separada ou n√£o.
                            if (sprintPos) pontosDaCorrida += (season.pontuacao.sprint[sprintPos] || 0);
                            
                            const racePos = Object.keys(res.corrida).find(pos => res.corrida[pos] == pilotoId);
                            if (racePos && res.corrida[racePos] !== 'DNF') pontosDaCorrida += (season.pontuacao.corrida[racePos] || 0);
                            if(res.voltaRapida == pilotoId) pontosDaCorrida += season.pontuacao.voltaRapida;
                        });
                        pontosAcumulados += pontosDaCorrida;
                        data.push(pontosAcumulados);
                    });
                    return { label: equipe.nome, data: data, borderColor: equipe.cor, backgroundColor: equipe.cor, fill: false, tension: 0.1 };
                });
                showModal(`<h3>Evolu√ß√£o das Equipes</h3><canvas id="teamEvolutionChart"></canvas><button onclick="hideModal()" class="btn btn-secundario" style="margin-top: 15px;">Fechar</button>`);
                const ctx = document.getElementById('teamEvolutionChart').getContext('2d');
                if (teamChart) teamChart.destroy();
                teamChart = new Chart(ctx, { type: 'line', data: { labels, datasets } });
            });
            
            document.getElementById('modal-backdrop').addEventListener('click', e => { if (e.target.id === 'modal-backdrop') hideModal(); });
            
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('sw.js').then(reg => console.log('SW registered.'), err => console.log('SW registration failed: ', err));
                });
            }

            loadState();
            render();
        });
    </script>
</body>
</html>