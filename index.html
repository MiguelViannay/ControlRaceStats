<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>TV Viannay Race Esporte</title>
    
    <!-- === Adições para o App (PWA) === -->
    <meta name="theme-color" content="#121212"/>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <!-- =================================== -->

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <style>
        :root {
            --cor-branca: #FFFFFF; --cor-preta: #121212; --cor-cinza: #F0F2F5;
            --cor-cinza-escuro: #8A8A8A; --cor-destaque: #E53935; --cor-sucesso: #4CAF50;
            --cor-aviso: #FFC107; --cor-azul: #1976D2;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--cor-cinza); color: var(--cor-preta);
            overscroll-behavior-y: contain;
        }
        #app-container {
            display: flex; flex-direction: column; height: 100vh;
            max-width: 600px; margin: 0 auto; background-color: var(--cor-branca);
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        header {
            background-color: var(--cor-preta); color: var(--cor-branca); padding: 15px 20px;
            text-align: center; font-size: 1.2rem; font-weight: bold; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            background-size: cover; background-position: center;
        }
        #header-logo { max-height: 30px; max-width: 30px; }
        #readonly-banner {
            background-color: var(--cor-aviso); color: black; font-size: 0.8rem;
            padding: 5px; text-align: center; font-weight: bold;
        }
        main { flex-grow: 1; overflow-y: auto; padding: 20px; }
        nav {
            display: flex; justify-content: space-around; background-color: var(--cor-branca);
            border-top: 1px solid #ddd; padding: 10px 0; flex-shrink: 0;
        }
        .nav-button {
            background: none; border: none; color: var(--cor-cinza-escuro); display: flex;
            flex-direction: column; align-items: center; font-size: 0.7rem;
            cursor: pointer; transition: color 0.2s; width: 20%;
        }
        .nav-button.active { color: var(--cor-destaque); font-weight: bold; }
        .nav-button svg { width: 24px; height: 24px; margin-bottom: 4px; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card {
            background-color: var(--cor-branca); border: 1px solid #e0e0e0;
            border-radius: 8px; padding: 16px; margin-bottom: 16px;
        }
        h2 { font-size: 1.5rem; margin-bottom: 16px; }
        h3 { font-size: 1.2rem; margin-bottom: 12px; border-left: 4px solid var(--cor-destaque); padding-left: 8px;}
        .btn {
            display: inline-block; width: 100%; padding: 12px; border: none;
            border-radius: 8px; font-size: 1rem; font-weight: bold;
            text-align: center; cursor: pointer; transition: opacity 0.2s;
        }
        .btn:active { opacity: 0.8; }
        .btn-principal { background-color: var(--cor-destaque); color: var(--cor-branca); }
        .btn-secundario { background-color: var(--cor-cinza); color: var(--cor-preta); }
        .btn-sucesso { background-color: var(--cor-sucesso); color: var(--cor-branca); }
        .input-group { margin-bottom: 16px; }
        .input-group label { display: block; margin-bottom: 6px; font-weight: 500; }
        .input-group input, .input-group select, .input-group textarea {
            width: 100%; padding: 10px; border: 1px solid #ccc;
            border-radius: 6px; font-size: 1rem;
        }
        .lista-item {
            display: flex; align-items: center; padding: 10px;
            border-bottom: 1px solid var(--cor-cinza);
        }
        .lista-item:last-child { border-bottom: none; }
        .item-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 12px; background-color: #eee; }
        .item-info { flex-grow: 1; }
        .item-info p { font-size: 1rem; font-weight: 500; }
        .item-info span { font-size: 0.8rem; color: #666; }
        .item-cor { width: 20px; height: 20px; border-radius: 50%; margin-right: 12px; border: 2px solid var(--cor-branca); box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        .action-buttons { display: flex; align-items: center; }
        .action-btn { background: none; border: none; cursor: pointer; padding: 5px; }
        .noticia-img {
            width: 100%; height: 150px; object-fit: cover;
            border-radius: 8px; margin-bottom: 12px;
        }
        .modal-backdrop {
            position: fixed; inset: 0; background-color: rgba(0,0,0,0.6);
            display: flex; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 100;
        }
        .modal-backdrop.visible { opacity: 1; pointer-events: auto; }
        .modal-content {
            background-color: var(--cor-branca); border-radius: 12px; padding: 20px;
            width: 90%; max-width: 500px; max-height: 85vh;
            overflow-y: auto; transform: scale(0.95); transition: transform 0.3s;
        }
        .modal-backdrop.visible .modal-content { transform: scale(1); }
        .tabela { width: 100%; border-collapse: collapse; }
        .tabela th, .tabela td { padding: 8px; text-align: left; border-bottom: 1px solid #eee; vertical-align: middle; }
        .tabela th { font-size: 0.8rem; color: #666; }
        .tabela td.pos { font-weight: bold; width: 30px; }
        .tabela .piloto-info { display: flex; align-items: center; gap: 8px; }
        .tabela .piloto-info img { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
        .status {
            padding: 4px 8px; border-radius: 12px; font-size: 0.7rem;
            font-weight: bold; color: var(--cor-branca);
        }
        .status-espera { background-color: var(--cor-cinza-escuro); }
        .status-ativa { background-color: var(--cor-aviso); color: var(--cor-preta); }
        .status-finalizada { background-color: var(--cor-sucesso); }
        .sprint-badge {
            background-color: var(--cor-destaque); color: white; font-size: 0.6rem;
            padding: 2px 6px; border-radius: 8px; margin-left: 8px; font-weight: bold;
        }
        .tabs { display: flex; border-bottom: 1px solid #ccc; margin-bottom: 16px; }
        .tab-button {
            padding: 10px 16px; cursor: pointer; background: none; border: none;
            border-bottom: 3px solid transparent; font-size: 1rem;
        }
        .tab-button.active { border-bottom-color: var(--cor-destaque); font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>
    <div id="app-container">
        <div id="readonly-banner" class="hidden">Modo de Visualização</div>
        <header>
            <img id="header-logo" src="" alt="Logo" class="hidden">
            <span id="header-title">TV Viannay Race Esporte</span>
        </header>
        <main id="main-content">
            <!-- PÁGINA: INÍCIO / TEMPORADA -->
            <div id="page-inicio" class="page active">
                <div id="selecao-temporada-view">
                    <h2>Minhas Temporadas</h2>
                    <div id="lista-temporadas" class="card"></div>
                    <button id="btn-nova-temporada" class="btn btn-principal">Criar Nova Temporada</button>
                </div>
                <div id="dashboard-temporada-view" class="hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h2 id="temporada-nome" style="margin: 0;"></h2>
                        <button id="btn-mudar-temporada" class="btn btn-secundario" style="width: auto; padding: 8px 12px;">Mudar</button>
                    </div>
                    <div class="card">
                        <h3>Equipes</h3>
                        <div id="dashboard-lista-equipes"></div>
                    </div>
                    <div class="card">
                        <h3>Pilotos</h3>
                        <div id="dashboard-lista-pilotos"></div>
                    </div>
                    <div class="card">
                        <h3>Últimas Notícias</h3>
                        <div id="dashboard-lista-noticias"></div>
                    </div>
                </div>
            </div>

            <!-- PÁGINA: CALENDÁRIO -->
            <div id="page-calendario" class="page">
                <h2>Calendário</h2>
                <div id="lista-corridas"></div>
            </div>
            
            <!-- PÁGINA: CLASSIFICAÇÃO -->
            <div id="page-classificacao" class="page">
                <h2>Classificação</h2>
                <div class="tabs">
                    <button class="tab-button active" data-tab="pilotos">Pilotos</button>
                    <button class="tab-button" data-tab="equipes">Equipes</button>
                    <button class="tab-button" data-tab="fas">Fãs</button>
                </div>

                <div id="tab-pilotos" class="tab-content active">
                    <div class="card" style="padding: 0;">
                        <table class="tabela">
                            <thead><tr><th>Pos</th><th>Piloto</th><th>Pts</th></tr></thead>
                            <tbody id="tabela-pilotos"></tbody>
                        </table>
                    </div>
                </div>
                <div id="tab-equipes" class="tab-content">
                    <div style="margin-bottom: 20px;">
                        <button id="btn-ver-grafico" class="btn btn-secundario">Ver Gráfico de Evolução de Equipes</button>
                    </div>
                    <div class="card" style="padding: 0;">
                        <table class="tabela">
                            <thead><tr><th>Pos</th><th>Equipe</th><th>Pts</th></tr></thead>
                            <tbody id="tabela-equipes"></tbody>
                        </table>
                    </div>
                </div>
                <div id="tab-fas" class="tab-content">
                    <div class="card" style="padding: 0;">
                        <table class="tabela">
                            <thead><tr><th>Pos</th><th>Piloto</th><th>Fãs</th></tr></thead>
                            <tbody id="tabela-fas"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- PÁGINA: AMIGOS -->
            <div id="page-amigos" class="page">
                <h2>Temporadas de Amigos</h2>
                <div class="card">
                    <h3>Carregar Temporada</h3>
                    <form id="form-load-shared">
                        <div class="input-group">
                            <label for="shared-code">Cole o código da temporada aqui</label>
                            <textarea id="shared-code" rows="3" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-principal">Carregar</button>
                    </form>
                </div>
                <div id="lista-temporadas-amigos" class="card"></div>
            </div>

            <!-- PÁGINA: ADMIN -->
            <div id="page-admin" class="page">
                <h2>Administração</h2>
                <div class="card">
                    <h3>Gerenciar Itens</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                        <button class="btn btn-secundario" data-action="add-equipe">Adicionar Equipe</button>
                        <button class="btn btn-secundario" data-action="add-piloto">Adicionar Piloto</button>
                        <button class="btn btn-secundario" data-action="add-corrida">Adicionar Etapa</button>
                        <button class="btn btn-secundario" data-action="add-noticia">Publicar Notícia</button>
                    </div>
                </div>
                <div class="card">
                    <h3>Personalização da Temporada</h3>
                    <form id="form-theme">
                        <div class="input-group"><label>Título do Cabeçalho</label><input type="text" id="theme-header-title"></div>
                        <div class="input-group"><label>URL do Logo</label><input type="url" id="theme-header-logo" placeholder="https://..."></div>
                        <div class="input-group"><label>Banner do Cabeçalho (URL ou Cor)</label><input type="text" id="theme-header-banner" placeholder="https://... ou #código"></div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                            <div class="input-group"><label>Cor Destaque</label><input type="color" id="theme-cor-destaque"></div>
                            <div class="input-group"><label>Cor Cabeçalho</label><input type="color" id="theme-cor-preta"></div>
                            <div class="input-group"><label>Cor Fundo</label><input type="color" id="theme-cor-cinza"></div>
                        </div>
                        <button type="submit" class="btn btn-sucesso">Salvar Tema</button>
                    </form>
                </div>
                <div class="card">
                    <h3>Configuração de Pontos</h3>
                    <form id="form-pontuacao">
                        <h4>Corrida Principal</h4>
                        <div id="pontos-corrida-container"></div>
                        <button type="button" class="btn-add-pos" data-tipo="corrida">+ Posição</button>
                        
                        <h4 style="margin-top:20px;">Corrida Sprint</h4>
                        <div id="pontos-sprint-container"></div>
                        <button type="button" class="btn-add-pos" data-tipo="sprint">+ Posição</button>

                        <h4 style="margin-top:20px;">Qualificação</h4>
                        <div id="pontos-quali-container"></div>
                        <button type="button" class="btn-add-pos" data-tipo="quali">+ Posição</button>
                        
                        <h4 style="margin-top:20px;">Ponto Extra</h4>
                        <div class="input-group">
                            <label for="ponto-volta-rapida">Pontos por Volta Mais Rápida (Top 10)</label>
                            <input type="number" id="ponto-volta-rapida" min="0">
                        </div>
                        <button type="submit" class="btn btn-sucesso" style="margin-top: 20px;">Salvar Pontuação</button>
                    </form>
                </div>
                 <div class="card">
                    <h3>Compartilhar</h3>
                    <button id="btn-share" class="btn btn-principal" style="background-color: var(--cor-azul);">Gerar Código de Compartilhamento</button>
                </div>
            </div>
        </main>
        
        <nav>
            <button class="nav-button active" data-page="inicio"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" /></svg>Temporada</button>
            <button class="nav-button" data-page="calendario"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0h18M-7.5 12h1.5" /></svg>Calendário</button>
            <button class="nav-button" data-page="classificacao"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" /></svg>Tabela</button>
            <button class="nav-button" data-page="amigos"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m-7.289 2.72a3 3 0 0 1-4.682-2.72 9.094 9.094 0 0 1 3.741-.479m7.289 2.72-7.289-2.72m0 0a3 3 0 1 0-4.682 2.72M12 18.72v-2.72c0-.956.22-1.859.62-2.688M12 18.72c-1.018 0-1.992-.206-2.87-.577m2.87.577a3 3 0 1 1 4.682-2.72M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>Amigos</button>
            <button class="nav-button" data-page="admin"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.343 3.94c.09-.542.56-.94 1.11-.94h1.093c.55 0 1.02.398 1.11.94l.149.894c.07.424.384.764.78.93.398.164.855.142 1.205-.108l.737-.527c.446-.318.99-.318 1.436 0l.775.775c.445.446.445 1.188 0 1.634l-.527.737c-.25.35-.272.806-.108 1.204.165.397.505.71.93.78l.893.15c.543.09.94.56.94 1.11v1.093c0 .55-.397 1.02-.94 1.11l-.893.149c-.425.07-.765.383-.93.78-.165.398-.143.854.108 1.204l.527.738c.446.445.446 1.187 0 1.634l-.775.775c-.446.446-1.188.446-1.634 0l-.738-.527c-.35-.25-.806-.272-1.204-.108-.397.165-.71.505-.78.93l-.15.893c-.09.543-.56.94-1.11.94h-1.093c-.55 0-1.02-.397-1.11-.94l-.149-.893c-.07-.425-.383-.765-.78-.93-.398-.165-.854-.143-1.204.108l-.738.527c-.445.446-1.187.446-1.634 0l-.775-.775c-.446-.445-.446-1.187 0-1.634l.527-.738c.25-.35.272-.806.108-1.204-.165-.397-.505-.71-.93-.78l-.894-.15c-.542-.09-.94-.56-.94-1.11v-1.093c0-.55.398-1.02.94-1.11l.894-.149c.424-.07.764-.383.93-.78.165-.398.143-.854-.108-1.204l-.527-.738c-.446-.445-.446-1.187 0-1.634l.775-.775c.446-.446 1.188-.446 1.634 0l.738.527c.35.25.806.272 1.204.108.397-.165.71-.505.78-.93l.15-.893Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>Admin</button>
        </nav>
    </div>

    <!-- MODAIS -->
    <div id="modal-backdrop" class="modal-backdrop">
        <div id="modal-content" class="modal-content"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const APP_STORAGE_KEY = 'viannayRaceApp_v6';
            let state = {};
            let isReadOnly = false;
            let viewedSeason = null;
            let teamChart = null;

            const createNewSeason = (nome) => ({
                id: Date.now(),
                nome,
                theme: {
                    corDestaque: '#E53935', corPreta: '#121212', corCinza: '#F0F2F5',
                    headerTitle: 'TV Viannay Race Esporte', headerLogo: '', headerBanner: ''
                },
                equipes: [],
                pilotos: [],
                calendario: [],
                noticias: [],
                pontuacao: {
                    corrida: { 1: 25, 2: 18, 3: 15, 4: 12, 5: 10, 6: 8, 7: 6, 8: 4, 9: 2, 10: 1 },
                    sprint: { 1: 8, 2: 7, 3: 6, 4: 5, 5: 4, 6: 3, 7: 2, 8: 1 },
                    quali: { 1: 3, 2: 2, 3: 1 },
                    voltaRapida: 1
                }
            });

            const saveState = () => {
                try {
                    localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(state));
                } catch (e) {
                    console.error("Erro ao salvar o estado:", e);
                }
            };
            const loadState = () => {
                const savedState = localStorage.getItem(APP_STORAGE_KEY);
                if (savedState) {
                    state = JSON.parse(savedState);
                } else {
                    state = { seasons: {}, sharedSeasons: {}, currentSeasonId: null };
                }
                 if (!state.sharedSeasons) state.sharedSeasons = {};
            };

            const getCurrentSeason = () => {
                if (isReadOnly) return viewedSeason;
                return state.currentSeasonId ? state.seasons[state.currentSeasonId] : null;
            }

            const applyTheme = (theme) => {
                const root = document.documentElement;
                root.style.setProperty('--cor-destaque', theme.corDestaque);
                root.style.setProperty('--cor-preta', theme.corPreta);
                root.style.setProperty('--cor-cinza', theme.corCinza);

                const header = document.querySelector('header');
                const headerTitle = document.getElementById('header-title');
                const headerLogo = document.getElementById('header-logo');

                headerTitle.textContent = theme.headerTitle || 'TV Viannay Race Esporte';
                if (theme.headerLogo) {
                    headerLogo.src = theme.headerLogo;
                    headerLogo.classList.remove('hidden');
                } else {
                    headerLogo.classList.add('hidden');
                }

                if (theme.headerBanner) {
                    if (theme.headerBanner.startsWith('#') || theme.headerBanner.startsWith('rgb')) {
                        header.style.backgroundImage = 'none';
                        header.style.backgroundColor = theme.headerBanner;
                    } else {
                        header.style.backgroundImage = `url(${theme.headerBanner})`;
                    }
                } else {
                    header.style.backgroundImage = 'none';
                    header.style.backgroundColor = 'var(--cor-preta)';
                }
            };

            const render = () => {
                const currentSeason = getCurrentSeason();
                if (currentSeason) {
                    applyTheme(currentSeason.theme);
                    document.getElementById('selecao-temporada-view').classList.add('hidden');
                    document.getElementById('dashboard-temporada-view').classList.remove('hidden');
                    document.getElementById('temporada-nome').textContent = currentSeason.nome;
                    renderDashboard();
                    renderCalendario();
                    renderClassificacao();
                    renderNoticias();
                    renderAdminPage();
                    renderAmigosPage();
                } else {
                    document.getElementById('dashboard-temporada-view').classList.add('hidden');
                    document.getElementById('selecao-temporada-view').classList.remove('hidden');
                    renderListaTemporadas();
                }
            };

            const renderListaTemporadas = () => {
                const lista = document.getElementById('lista-temporadas');
                const seasonIds = Object.keys(state.seasons);
                lista.innerHTML = seasonIds.length === 0 ? '<p>Nenhuma temporada criada.</p>' : '<h3>Selecione uma Temporada</h3>';
                seasonIds.forEach(id => {
                    const season = state.seasons[id];
                    lista.innerHTML += `
                        <div class="lista-item" style="cursor:pointer;" data-action="select-season" data-id="${id}">
                            <div class="item-info"><p>${season.nome}</p></div>
                            <button class="action-btn" data-action="delete-season" data-id="${id}">🗑️</button>
                        </div>
                    `;
                });
            };

            const renderDashboard = () => {
                const season = getCurrentSeason();
                if (!season) return;
                const renderMiniLista = (containerId, items, renderFn) => {
                    const container = document.getElementById(containerId);
                    container.innerHTML = items.length ? '' : '<p>Nenhum item.</p>';
                    items.forEach(item => container.innerHTML += renderFn(item));
                };
                renderMiniLista('dashboard-lista-equipes', season.equipes, (e) => `<div class="lista-item"><div class="item-cor" style="background-color: ${e.cor};"></div><p>${e.nome}</p></div>`);
                renderMiniLista('dashboard-lista-pilotos', season.pilotos, (p) => {
                    const equipe = season.equipes.find(e => Number(e.id) === Number(p.equipeId));
                    return `<div class="lista-item"><div class="item-cor" style="background-color: ${equipe?.cor || '#ccc'};"></div><p>${p.nome}</p></div>`;
                });
                const ultimasNoticias = [...season.noticias].sort((a, b) => b.data - a.data).slice(0, 3);
                renderMiniLista('dashboard-lista-noticias', ultimasNoticias, (n) => `<div class="lista-item"><div class="item-info"><p>${n.titulo}</p><span class="text-sm">${new Date(n.data).toLocaleDateString()}</span></div></div>`);
            };
            
            const renderCalendario = () => {
                const lista = document.getElementById('lista-corridas');
                const season = getCurrentSeason();
                if (!season) {
                    lista.innerHTML = '<p>Selecione uma temporada para ver o calendário.</p>';
                    return;
                }
                lista.innerHTML = season.calendario.length ? '' : '<p>Nenhuma etapa no calendário.</p>';
                [...season.calendario].sort((a,b) => a.id - b.id).forEach(c => {
                    lista.innerHTML += `
                        <div class="card">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div style="display: flex; align-items: center;">
                                    <img src="${c.bandeira || 'https://placehold.co/40x40/eee/ccc?text=?'}" alt="Bandeira" class="item-avatar" style="border-radius: 4px;">
                                    <div>
                                        <p style="font-weight: bold; display: flex; align-items: center;">
                                            ${c.nome}
                                            ${c.isSprint ? '<span class="sprint-badge">SPRINT</span>' : ''}
                                        </p>
                                        <span class="status status-${c.status}">${c.status.toUpperCase()}</span>
                                    </div>
                                </div>
                                ${!isReadOnly ? `<div class="action-buttons">
                                    <button class="action-btn" data-action="edit-corrida" data-id="${c.id}">✏️</button>
                                    <button class="action-btn" data-action="delete" data-id="${c.id}" data-tipo="corrida">🗑️</button>
                                </div>` : ''}
                            </div>
                            <div style="margin-top: 10px; display:flex; gap: 10px;">
                                ${c.status === 'finalizada' ? 
                                    `<button class="btn btn-secundario" data-action="ver-resultados" data-id="${c.id}">Ver Resultados</button>` :
                                    (!isReadOnly ? `<button class="btn btn-principal" data-action="lancar-resultados" data-id="${c.id}">Lançar Resultados</button>` : '')
                                }
                            </div>
                        </div>`;
                });
            };

            const renderClassificacao = () => {
                const season = getCurrentSeason();
                if (!season) return;

                const pilotosOrdenados = [...season.pilotos].sort((a,b) => b.pontos - a.pontos);
                document.getElementById('tabela-pilotos').innerHTML = pilotosOrdenados.map((p, index) => {
                    const equipe = season.equipes.find(e => Number(e.id) === Number(p.equipeId));
                    return `<tr data-action="ver-piloto" data-id="${p.id}" style="cursor: pointer;">
                        <td class="pos">${index + 1}</td>
                        <td>
                            <div class="piloto-info">
                                <div class="item-cor" style="background-color: ${equipe?.cor || '#ccc'}"></div>
                                <img src="${p.img || 'https://placehold.co/40x40/eee/ccc?text=?'}" alt="${p.nome}">
                                <span>${p.nome}</span>
                            </div>
                        </td>
                        <td style="font-weight: bold; text-align: right;">${p.pontos}</td></tr>`;
                }).join('');

                const pontosEquipes = season.equipes.map(eq => ({
                    ...eq,
                    pontos: season.pilotos.filter(p => Number(p.equipeId) === Number(eq.id)).reduce((acc, p) => acc + p.pontos, 0)
                })).sort((a,b) => b.pontos - a.pontos);
                document.getElementById('tabela-equipes').innerHTML = pontosEquipes.map((eq, index) => `
                     <tr data-action="ver-equipe" data-id="${eq.id}" style="cursor: pointer;">
                        <td class="pos">${index + 1}</td>
                        <td><div class="piloto-info"><img src="${eq.logo}" class="item-avatar"><span>${eq.nome}</span></div></td>
                        <td style="font-weight: bold; text-align: right;">${eq.pontos}</td></tr>`).join('');

                const fasOrdenados = [...season.pilotos].sort((a,b) => b.fas - a.fas);
                document.getElementById('tabela-fas').innerHTML = fasOrdenados.map((p, index) => {
                    const equipe = season.equipes.find(e => Number(e.id) === Number(p.equipeId));
                    return `<tr data-action="ver-piloto" data-id="${p.id}" style="cursor: pointer;">
                        <td class="pos">${index + 1}</td>
                        <td>
                            <div class="piloto-info">
                                <div class="item-cor" style="background-color: ${equipe?.cor || '#ccc'}"></div>
                                <img src="${p.img || 'https://placehold.co/40x40/eee/ccc?text=?'}" alt="${p.nome}">
                                <span>${p.nome}</span>
                            </div>
                        </td>
                        <td style="font-weight: bold; text-align: right;">${p.fas.toLocaleString('pt-BR')}</td></tr>`;
                }).join('');
            };

            const renderNoticias = () => {
                const lista = document.getElementById('lista-noticias');
                const season = getCurrentSeason();
                if (!season) {
                    lista.innerHTML = '<p>Selecione uma temporada para ver as notícias.</p>';
                    return;
                }
                lista.innerHTML = season.noticias.length ? '' : '<p>Nenhuma notícia publicada.</p>';
                [...season.noticias].sort((a, b) => b.data - a.data).forEach(n => {
                    const pilotos = n.pilotosMarcados?.map(pid => season.pilotos.find(p => p.id == pid)?.nome).filter(Boolean).join(', ');
                    const equipes = n.equipesMarcadas?.map(eid => season.equipes.find(e => e.id == eid)?.nome).filter(Boolean).join(', ');
                    lista.innerHTML += `
                        <div class="card">
                            <div style="display:flex; justify-content: space-between; align-items: start;">
                                <div><h4>${n.titulo}</h4><p style="font-size: 0.8rem; color: #555; margin-bottom: 10px;">${new Date(n.data).toLocaleDateString()}</p></div>
                                ${!isReadOnly ? `<button class="action-btn" data-action="delete" data-id="${n.id}" data-tipo="noticia">🗑️</button>` : ''}
                            </div>
                            ${n.imgUrl ? `<img src="${n.imgUrl}" class="noticia-img" alt="Imagem da notícia">` : ''}
                            <p>${n.conteudo}</p>
                            ${pilotos ? `<p style="font-size: 0.8rem; color: #888; margin-top: 10px;"><i>Pilotos: ${pilotos}</i></p>` : ''}
                            ${equipes ? `<p style="font-size: 0.8rem; color: #888; margin-top: 5px;"><i>Equipes: ${equipes}</i></p>` : ''}
                        </div>`;
                });
            };

            const renderAdminPage = () => {
                const season = getCurrentSeason();
                if (!season) return;
                
                const theme = season.theme;
                document.getElementById('theme-header-title').value = theme.headerTitle;
                document.getElementById('theme-header-logo').value = theme.headerLogo;
                document.getElementById('theme-header-banner').value = theme.headerBanner;
                document.getElementById('theme-cor-destaque').value = theme.corDestaque;
                document.getElementById('theme-cor-preta').value = theme.corPreta;
                document.getElementById('theme-cor-cinza').value = theme.corCinza;

                const renderPontosInputs = (tipo) => {
                    const container = document.getElementById(`pontos-${tipo}-container`);
                    const pontos = season.pontuacao[tipo];
                    container.innerHTML = '';
                    Object.keys(pontos).sort((a, b) => Number(a) - Number(b)).forEach(pos => {
                        container.innerHTML += `<div class="input-group" style="display: flex; align-items: center; gap: 10px;"><label style="flex-basis: 60px;">${pos}º:</label><input type="number" value="${pontos[pos]}" data-tipo="${tipo}" data-pos="${pos}" class="ponto-input" style="flex-grow: 1;"><button type="button" class="btn-remove-pos" data-tipo="${tipo}" data-pos="${pos}">X</button></div>`;
                    });
                };
                renderPontosInputs('corrida');
                renderPontosInputs('sprint');
                renderPontosInputs('quali');
                document.getElementById('ponto-volta-rapida').value = season.pontuacao.voltaRapida;
            };

            const renderAmigosPage = () => {
                const lista = document.getElementById('lista-temporadas-amigos');
                const sharedIds = Object.keys(state.sharedSeasons);
                lista.innerHTML = sharedIds.length === 0 ? '<p>Nenhuma temporada de amigo carregada.</p>' : '<h3>Temporadas Salvas</h3>';
                sharedIds.forEach(id => {
                    const season = state.sharedSeasons[id];
                    lista.innerHTML += `
                        <div class="lista-item" style="cursor:pointer;" data-action="select-shared-season" data-id="${id}">
                            <div class="item-info"><p>${season.nome}</p></div>
                            <button class="action-btn" data-action="delete-shared-season" data-id="${id}">🗑️</button>
                        </div>
                    `;
                });
            };

            const showModal = (content) => {
                document.getElementById('modal-content').innerHTML = content;
                document.getElementById('modal-backdrop').classList.add('visible');
            };
            const hideModal = () => document.getElementById('modal-backdrop').classList.remove('visible');
            
            const calcularPontosTotais = () => {
                const season = getCurrentSeason();
                if (!season) return;
                season.pilotos.forEach(p => p.pontos = 0);
                season.calendario.forEach(corrida => {
                    if (corrida.status === 'finalizada' && corrida.resultados) {
                        const res = corrida.resultados;
                        const getPiloto = id => season.pilotos.find(p => p.id == id);
                        
                        Object.entries(res.grid).forEach(([pos, pId]) => { 
                            const p = getPiloto(pId); 
                            if (p && season.pontuacao.quali[pos]) {
                                p.pontos += (season.pontuacao.quali[pos] || 0);
                            }
                        });

                        if (corrida.isSprint) {
                            Object.entries(res.sprint).forEach(([pos, pId]) => { const p = getPiloto(pId); if (p && pId !== 'DNF') p.pontos += (season.pontuacao.sprint[pos] || 0); });
                        }

                        Object.entries(res.corrida).forEach(([pos, pId]) => { const p = getPiloto(pId); if (p && pId !== 'DNF') p.pontos += (season.pontuacao.corrida[pos] || 0); });
                        
                        if(res.voltaRapida) { 
                            const p = getPiloto(res.voltaRapida); 
                            if(p) {
                                const posCorrida = Object.keys(res.corrida).find(pos => res.corrida[pos] == res.voltaRapida);
                                if (posCorrida && posCorrida <= 10) {
                                    p.pontos += (season.pontuacao.voltaRapida || 0);
                                }
                            }
                        }
                    }
                });
            };

            const atualizarFasEReputacao = (resultados, noticia = null) => {
                const season = getCurrentSeason();
                if (!season) return;
                const totalPilotos = season.pilotos.length;
                if (totalPilotos === 0) return;

                if(resultados) {
                    season.pilotos.forEach(piloto => {
                        const posGrid = Object.keys(resultados.grid).find(pos => resultados.grid[pos] == piloto.id);
                        const posCorrida = Object.keys(resultados.corrida).find(pos => resultados.corrida[pos] == piloto.id);
                        
                        if(posGrid) piloto.fas += Math.floor((totalPilotos - parseInt(posGrid) + 1) * 5);

                        if (posCorrida && resultados.corrida[posCorrida] !== 'DNF') {
                            piloto.fas += Math.floor((totalPilotos - parseInt(posCorrida) + 1) * 50 * (Math.random() * 0.5 + 0.8));
                        } else {
                            piloto.fas -= Math.floor(Math.random() * 100);
                        }
                    });
                }

                if (noticia) {
                    const { impacto, pilotosMarcados } = noticia;
                    const fanChange = { 'positivo': 500, 'neutro': 50, 'negativo': -350 };
                    pilotosMarcados.forEach(pId => {
                        const piloto = season.pilotos.find(p => p.id == pId);
                        if (piloto) piloto.fas += fanChange[impacto];
                    });
                }

                season.pilotos.forEach(piloto => {
                    if (piloto.fas < 0) piloto.fas = 0;
                });

                const pilotosOrdenados = [...season.pilotos].sort((a, b) => b.pontos - a.pontos);
                const rankingPilotos = {};
                pilotosOrdenados.forEach((p, i) => rankingPilotos[p.id] = i + 1);
                
                const pontosEquipes = season.equipes.map(eq => ({
                    id: eq.id,
                    pontos: season.pilotos.filter(p => Number(p.equipeId) === Number(eq.id)).reduce((acc, p) => acc + p.pontos, 0)
                })).sort((a,b) => b.pontos - a.pontos);
                const rankingEquipes = {};
                pontosEquipes.forEach((eq, i) => rankingEquipes[eq.id] = i + 1);

                season.pilotos.forEach(piloto => {
                    const rankPiloto = rankingPilotos[piloto.id];
                    const rankEquipe = rankingEquipes[piloto.equipeId];
                    if (!rankPiloto || !rankEquipe) {
                        piloto.reputacao = 5.0;
                        return;
                    }
                    
                    let reputacaoBase = totalPilotos > 1 ? ((totalPilotos - rankPiloto) / (totalPilotos - 1)) * 10 : 10;
                    const expectativaEquipe = pontosEquipes.length > 1 ? ((pontosEquipes.length - rankEquipe) / (pontosEquipes.length - 1)) : 1;
                    const diff = reputacaoBase - (expectativaEquipe * 10);
                    let reputacaoFinal = reputacaoBase + (diff / 2);
                    
                    piloto.reputacao = Math.max(0, Math.min(10, reputacaoFinal));
                });
            };

            // --- Event Listeners ---
            document.querySelector('nav').addEventListener('click', (e) => {
                const button = e.target.closest('.nav-button');
                if (button) {
                    const pageId = `page-${button.dataset.page}`;
                    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                    document.getElementById(pageId).classList.add('active');
                    document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
                    button.classList.add('active');
                }
            });

            const tabsContainer = document.querySelector('#page-classificacao .tabs');
            if(tabsContainer) {
                tabsContainer.addEventListener('click', e => {
                    if (e.target.classList.contains('tab-button')) {
                        const tabId = `tab-${e.target.dataset.tab}`;
                        document.querySelectorAll('#page-classificacao .tab-button').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        document.querySelectorAll('#page-classificacao .tab-content').forEach(c => c.classList.remove('active'));
                        document.getElementById(tabId).classList.add('active');
                    }
                });
            }

            document.getElementById('btn-nova-temporada').addEventListener('click', () => {
                const nome = prompt('Digite o nome da nova temporada:', `Temporada ${new Date().getFullYear()}`);
                if (nome) {
                    const novaTemporada = createNewSeason(nome);
                    state.seasons[novaTemporada.id] = novaTemporada;
                    state.currentSeasonId = novaTemporada.id;
                    saveState();
                    render();
                }
            });

            document.getElementById('btn-mudar-temporada').addEventListener('click', () => {
                isReadOnly = false;
                viewedSeason = null;
                document.querySelector('[data-page="admin"]').classList.remove('hidden');
                document.getElementById('readonly-banner').classList.add('hidden');
                
                state.currentSeasonId = null;
                saveState();
                render();
            });

            document.getElementById('main-content').addEventListener('click', e => {
                const actionBtn = e.target.closest('[data-action]');
                if (!actionBtn) return;

                const { action, id } = actionBtn.dataset;
                const season = getCurrentSeason();

                switch(action) {
                    case 'select-season': state.currentSeasonId = id; saveState(); render(); break;
                    case 'select-shared-season':
                        isReadOnly = true;
                        viewedSeason = state.sharedSeasons[id];
                        document.querySelector('[data-page="admin"]').classList.add('hidden');
                        document.getElementById('readonly-banner').classList.remove('hidden');
                        document.querySelector('.nav-button[data-page="inicio"]').click();
                        render();
                        break;
                    case 'delete-season':
                        if (confirm(`Tem certeza que deseja apagar a temporada "${state.seasons[id].nome}"? A ação não pode ser desfeita.`)) {
                            delete state.seasons[id];
                            if (state.currentSeasonId == id) state.currentSeasonId = null;
                            saveState(); render();
                        }
                        break;
                    case 'delete-shared-season':
                        if (confirm(`Tem certeza que deseja remover a temporada "${state.sharedSeasons[id].nome}" da sua lista?`)) {
                            delete state.sharedSeasons[id];
                            saveState(); renderAmigosPage();
                        }
                        break;
                    case 'delete':
                        const { tipo } = actionBtn.dataset;
                        if (confirm(`Tem certeza que deseja remover este item (${tipo})?`)) {
                            if (tipo === 'equipe') {
                                season.equipes = season.equipes.filter(item => item.id != id);
                                season.pilotos.forEach(p => { if (p.equipeId == id) p.equipeId = null; });
                            }
                            if (tipo === 'piloto') season.pilotos = season.pilotos.filter(item => item.id != id);
                            if (tipo === 'corrida') season.calendario = season.calendario.filter(item => item.id != id);
                            if (tipo === 'noticia') season.noticias = season.noticias.filter(item => item.id != id);
                            saveState(); render();
                        }
                        break;
                    case 'add-equipe': showEditEquipeModal(); break;
                    case 'add-piloto': showEditPilotoModal(); break;
                    case 'add-corrida': showEditCorridaModal(); break;
                    case 'add-noticia': showEditNoticiaModal(); break;
                    case 'edit-equipe': showEditEquipeModal(id); break;
                    case 'edit-piloto': showEditPilotoModal(id); break;
                    case 'edit-corrida': showEditCorridaModal(id); break;
                    case 'lancar-resultados': showResultadosModal(id); break;
                    case 'ver-resultados': showVerResultadosModal(id); break;
                    case 'ver-piloto': showVerPilotoModal(id); break;
                    case 'ver-equipe': showVerEquipeModal(id); break;
                }
            });
            
            function showEditEquipeModal(id = null) {
                const season = getCurrentSeason();
                const equipe = id ? season.equipes.find(e => e.id == id) : null;
                showModal(`<h3>${equipe ? 'Editar' : 'Adicionar'} Equipe</h3><form id="form-edit-equipe" data-id="${id || ''}"><div class="input-group"><label>Nome</label><input type="text" id="equipe-nome" value="${equipe?.nome || ''}" required></div><div class="input-group"><label>URL do Logo</label><input type="url" id="equipe-logo" value="${equipe?.logo || ''}" placeholder="https://..." required></div><div class="input-group"><label>Cor</label><input type="color" id="equipe-cor" value="${equipe?.cor || '#ff0000'}"></div><button type="submit" class="btn btn-principal">Salvar</button></form>`);
            }

            function showEditPilotoModal(id = null) {
                const season = getCurrentSeason();
                if (season.equipes.length === 0) { alert('Adicione uma equipe primeiro.'); return; }
                const piloto = id ? season.pilotos.find(p => p.id == id) : null;
                const options = season.equipes.map(e => `<option value="${e.id}" ${piloto?.equipeId == e.id ? 'selected' : ''}>${e.nome}</option>`).join('');
                showModal(`<h3>${piloto ? 'Editar' : 'Adicionar'} Piloto</h3><form id="form-edit-piloto" data-id="${id || ''}"><div class="input-group"><label>Nome</label><input type="text" id="piloto-nome" value="${piloto?.nome || ''}" required></div><div class="input-group"><label>URL da Imagem</label><input type="url" id="piloto-img" value="${piloto?.img || ''}" placeholder="https://..."></div><div class="input-group"><label>Equipe</label><select id="piloto-equipe" required>${options}</select></div><button type="submit" class="btn btn-principal">Salvar</button></form>`);
            }

            function showEditCorridaModal(id = null) {
                const season = getCurrentSeason();
                const corrida = id ? season.calendario.find(c => c.id == id) : null;
                showModal(`<h3>${corrida ? 'Editar' : 'Adicionar'} Etapa</h3><form id="form-edit-corrida" data-id="${id || ''}"><div class="input-group"><label>Nome</label><input type="text" id="corrida-nome-edit" value="${corrida?.nome || ''}" required></div><div class="input-group"><label>URL da Bandeira</label><input type="url" id="corrida-bandeira-edit" value="${corrida?.bandeira || ''}" placeholder="https://..."></div><div class="input-group" style="display:flex; align-items:center;"><input type="checkbox" id="corrida-sprint-edit" ${corrida?.isSprint ? 'checked' : ''} style="width:auto; margin-right: 10px;"><label for="corrida-sprint-edit" style="margin:0;">É uma Etapa Sprint?</label></div><button type="submit" class="btn btn-principal">Salvar</button></form>`);
            }

            function showEditNoticiaModal() {
                const season = getCurrentSeason();
                const pilotosOptions = season.pilotos.map(p => `<option value="${p.id}">${p.nome}</option>`).join('');
                const equipesOptions = season.equipes.map(e => `<option value="${e.id}">${e.nome}</option>`).join('');
                showModal(`<h3>Publicar Notícia</h3><form id="form-add-noticia"><div class="input-group"><label>Título</label><input type="text" id="noticia-titulo" required></div><div class="input-group"><label>URL da Imagem</label><input type="url" id="noticia-img" placeholder="https://..."></div><div class="input-group"><label>Conteúdo</label><textarea id="noticia-conteudo" rows="4" required></textarea></div><div class="input-group"><label>Impacto da Notícia</label><select id="noticia-impacto"><option value="positivo">Positivo</option><option value="neutro" selected>Neutro</option><option value="negativo">Negativo</option></select></div><div class="input-group"><label>Marcar Pilotos</label><select id="noticia-pilotos" multiple>${pilotosOptions}</select></div><div class="input-group"><label>Marcar Equipes</label><select id="noticia-equipes" multiple>${equipesOptions}</select></div><button type="submit" class="btn btn-principal">Publicar</button></form>`);
            }

            function showResultadosModal(id) {
                const season = getCurrentSeason();
                const corrida = season.calendario.find(c => c.id == id);
                const pilotoOptions = season.pilotos.map(p => `<option value="${p.id}">${p.nome}</option>`).join('');
                const createSelects = (type) => [...Array(season.pilotos.length)].map((_, i) => `<div class="input-group"><label>${i+1}º Lugar</label><select class="${type}-pos" data-pos="${i+1}"><option value="">--</option>${pilotoOptions}</select></div>`).join('');
                const createRaceSelects = () => [...Array(season.pilotos.length)].map((_, i) => `<div class="input-group"><label>${i+1}º Lugar</label><select class="corrida-pos" data-pos="${i+1}"><option value="">--</option>${pilotoOptions}<option value="DNF">DNF</option></select></div>`).join('');
                showModal(`<h3>Resultados para ${corrida.nome}</h3><form id="form-resultados" data-id="${id}"><h4>Grid de Largada / Qualificação</h4>${createSelects('grid')}<hr style="margin:20px 0">${corrida.isSprint ? `<h4>Sprint</h4>${createSelects('sprint')}<hr style="margin:20px 0">` : ''}<h4>Corrida</h4>${createRaceSelects()}<hr style="margin:20px 0"><h4>Volta Rápida</h4><div class="input-group"><select id="volta-rapida"><option value="">--</option>${pilotoOptions}</select></div><br><button type="submit" class="btn btn-sucesso">Salvar</button></form>`);
            }

            function showVerResultadosModal(id) {
                 const season = getCurrentSeason();
                 const corrida = season.calendario.find(c => c.id == id);
                 const res = corrida.resultados;
                 const getNome = (pId) => (pId === 'DNF') ? 'DNF' : season.pilotos.find(p => p.id == pId)?.nome || 'N/A';
                 const getPontosPilotoNaCorrida = (pilotoId) => {
                    if (pilotoId === 'DNF') return 0;
                    let pontos = 0;
                    Object.entries(res.grid).forEach(([pos, pId]) => { if(pId == pilotoId && season.pontuacao.quali[pos]) pontos += (season.pontuacao.quali[pos] || 0); });
                    if (corrida.isSprint) {
                        const sprintPos = Object.keys(res.sprint).find(pos => res.sprint[pos] == pilotoId);
                        if (sprintPos) pontos += (season.pontuacao.sprint[sprintPos] || 0);
                    }
                    const racePos = Object.keys(res.corrida).find(pos => res.corrida[pos] == pilotoId);
                    if (racePos && res.corrida[racePos] !== 'DNF') pontos += (season.pontuacao.corrida[racePos] || 0);
                    if(res.voltaRapida == pilotoId) {
                        const posCorrida = Object.keys(res.corrida).find(pos => res.corrida[pos] == res.voltaRapida);
                        if (posCorrida && posCorrida <= 10) pontos += season.pontuacao.voltaRapida;
                    }
                    return pontos;
                 };
                 
                 let html = `<h3>Resultados - ${corrida.nome}</h3>`;
                 html += `<h4>Corrida Principal</h4>` + Object.entries(res.corrida).sort((a,b) => Number(a[0]) - Number(b[0])).map(([pos, pId]) => `<p>${pos}º: ${getNome(pId)} ${pId !== 'DNF' ? `<strong>(+${getPontosPilotoNaCorrida(pId)} pts)</strong>` : ''}</p>`).join('');
                 if (corrida.isSprint && Object.keys(res.sprint).length > 0) html += `<h4 style="margin-top:15px;">Sprint</h4>` + Object.entries(res.sprint).sort((a,b) => Number(a[0]) - Number(b[0])).map(([pos, pId]) => `<p>${pos}º: ${getNome(pId)}</p>`).join('');
                 html += `<h4 style="margin-top:15px;">Grid de Largada</h4>` + Object.entries(res.grid).sort((a,b) => Number(a[0]) - Number(b[0])).map(([pos, pId]) => `<p>${pos}º: ${getNome(pId)}</p>`).join('');
                 if (res.voltaRapida) html += `<p style="margin-top:10px;"><strong>Volta Rápida:</strong> ${getNome(res.voltaRapida)}</p>`;
                 html += `<br><button onclick="hideModal()" class="btn btn-secundario">Fechar</button>`;
                 showModal(html);
            }

            function showVerPilotoModal(id) {
                const season = getCurrentSeason();
                const piloto = season.pilotos.find(p => Number(p.id) === Number(id));
                const equipe = season.equipes.find(e => Number(e.id) === Number(piloto.equipeId));
                const rank = [...season.pilotos].sort((a,b) => b.pontos - a.pontos).findIndex(p => Number(p.id) === Number(id)) + 1;
                let qualiPos = [], racePos = [];
                season.calendario.filter(c => c.status === 'finalizada' && c.resultados).forEach(c => {
                    const qp = Object.keys(c.resultados.grid).find(pos => c.resultados.grid[pos] == id);
                    const rp = Object.keys(c.resultados.corrida).find(pos => c.resultados.corrida[pos] == id);
                    if (qp) qualiPos.push(parseInt(qp));
                    if (rp) racePos.push(parseInt(rp));
                });
                const avgQuali = qualiPos.length ? (qualiPos.reduce((a,b) => a+b, 0) / qualiPos.length).toFixed(1) : 'N/A';
                const avgRace = racePos.length ? (racePos.reduce((a,b) => a+b, 0) / racePos.length).toFixed(1) : 'N/A';
                showModal(`<div style="text-align:center;"><img src="${piloto.img || 'https://placehold.co/80x80/eee/ccc?text=?'}" class="item-avatar" style="width:80px;height:80px;margin-bottom:10px;"><h2>${piloto.nome}</h2><p style="font-size:1.1rem;color:#555;">${equipe?.name || 'Sem equipe'}</p></div><div style="margin-top:20px;"><p><strong>Posição Geral:</strong> ${rank}º</p><p><strong>Pontos:</strong> ${piloto.pontos}</p><p><strong>Pos. Média Quali:</strong> ${avgQuali}</p><p><strong>Pos. Média Corrida:</strong> ${avgRace}</p><p><strong>Fãs:</strong> ${piloto.fas.toLocaleString('pt-BR')}</p><p><strong>Reputação:</strong> ${piloto.reputacao.toFixed(1)} / 10</p></div><br><button onclick="hideModal()" class="btn btn-secundario">Fechar</button>`);
            }
            
            function showVerEquipeModal(id) {
                const season = getCurrentSeason();
                const equipe = season.equipes.find(e => e.id == id);
                const pilotosDaEquipe = season.pilotos.filter(p => p.equipeId == id);
                const totalPontos = pilotosDaEquipe.reduce((acc, p) => acc + p.pontos, 0);
                showModal(`<div style="text-align:center;"><img src="${equipe.logo || 'https://placehold.co/80x80/eee/ccc?text=?'}" class="item-avatar" style="width:80px;height:80px;margin-bottom:10px;"><h2>${equipe.nome}</h2><p style="font-size:1.2rem;font-weight:bold;">${totalPontos} Pontos</p></div><div style="margin-top:20px;"><h3>Pilotos</h3>${pilotosDaEquipe.map(p => `<div class="lista-item"><p>${p.nome}</p></div>`).join('') || '<p>Nenhum piloto.</p>'}</div><br><button onclick="hideModal()" class="btn btn-secundario">Fechar</button>`);
            }

            document.getElementById('modal-backdrop').addEventListener('submit', (e) => {
                e.preventDefault();
                const form = e.target;
                const id = form.dataset.id;
                const season = getCurrentSeason();
                
                if (form.id === 'form-edit-equipe') {
                    const data = { nome: form.querySelector('#equipe-nome').value, logo: form.querySelector('#equipe-logo').value, cor: form.querySelector('#equipe-cor').value };
                    if (id) Object.assign(season.equipes.find(i => i.id == id), data);
                    else season.equipes.push({ id: Date.now(), ...data });
                }
                if (form.id === 'form-edit-piloto') {
                    const data = { nome: form.querySelector('#piloto-nome').value, img: form.querySelector('#piloto-img').value, equipeId: parseInt(form.querySelector('#piloto-equipe').value) };
                    if (id) Object.assign(season.pilotos.find(i => i.id == id), data);
                    else season.pilotos.push({ id: Date.now(), pontos: 0, fas: 1000, reputacao: 5.0, ...data });
                }
                if (form.id === 'form-edit-corrida') {
                    const data = { nome: form.querySelector('#corrida-nome-edit').value, bandeira: form.querySelector('#corrida-bandeira-edit').value, isSprint: form.querySelector('#corrida-sprint-edit').checked };
                    if (id) Object.assign(season.calendario.find(c => c.id == id), data);
                    else season.calendario.push({ id: Date.now(), status: 'espera', resultados: null, ...data });
                }
                if (form.id === 'form-add-noticia') {
                    const noticia = { id: Date.now(), titulo: form.querySelector('#noticia-titulo').value, conteudo: form.querySelector('#noticia-conteudo').value, imgUrl: form.querySelector('#noticia-img').value, impacto: form.querySelector('#noticia-impacto').value, pilotosMarcados: Array.from(form.querySelector('#noticia-pilotos').selectedOptions).map(o => o.value), equipesMarcadas: Array.from(form.querySelector('#noticia-equipes').selectedOptions).map(o => o.value), data: Date.now() };
                    season.noticias.push(noticia);
                    atualizarFasEReputacao(null, noticia);
                }
                if (form.id === 'form-resultados') {
                    const corrida = season.calendario.find(c => c.id == id);
                    const resultados = { grid: {}, sprint: {}, corrida: {}, voltaRapida: null };
                    form.querySelectorAll('.grid-pos').forEach(s => { if (s.value) resultados.grid[s.dataset.pos] = s.value; });
                    if (corrida.isSprint) {
                        form.querySelectorAll('.sprint-pos').forEach(s => { if (s.value) resultados.sprint[s.dataset.pos] = s.value; });
                    }
                    form.querySelectorAll('.corrida-pos').forEach(s => { if (s.value) resultados.corrida[s.dataset.pos] = s.value; });
                    resultados.voltaRapida = form.querySelector('#volta-rapida').value || null;
                    corrida.resultados = resultados;
                    corrida.status = 'finalizada';
                    calcularPontosTotais();
                    atualizarFasEReputacao(resultados);
                }
                saveState();
                render();
                hideModal();
            });

            document.getElementById('form-pontuacao').addEventListener('submit', e => {
                e.preventDefault();
                const season = getCurrentSeason();
                document.querySelectorAll('.ponto-input').forEach(input => {
                    const { tipo, pos } = input.dataset;
                    season.pontuacao[tipo][pos] = parseInt(input.value) || 0;
                });
                season.pontuacao.voltaRapida = parseInt(document.getElementById('ponto-volta-rapida').value) || 0;
                calcularPontosTotais();
                saveState();
                render();
                alert('Sistema de pontuação salvo!');
            });
            
            document.getElementById('form-theme').addEventListener('submit', e => {
                e.preventDefault();
                const season = getCurrentSeason();
                season.theme = {
                    headerTitle: document.getElementById('theme-header-title').value,
                    headerLogo: document.getElementById('theme-header-logo').value,
                    headerBanner: document.getElementById('theme-header-banner').value,
                    corDestaque: document.getElementById('theme-cor-destaque').value,
                    corPreta: document.getElementById('theme-cor-preta').value,
                    corCinza: document.getElementById('theme-cor-cinza').value,
                };
                applyTheme(season.theme);
                saveState();
                alert('Tema salvo!');
            });

            document.getElementById('page-admin').addEventListener('click', e => {
                const target = e.target;
                const season = getCurrentSeason();
                if(!season) return;
                if (target.classList.contains('btn-add-pos')) {
                    const { tipo } = target.dataset;
                    const nextPos = Object.keys(season.pontuacao[tipo]).length + 1;
                    season.pontuacao[tipo][nextPos] = 0;
                    renderAdminPage();
                }
                if (target.classList.contains('btn-remove-pos')) {
                    const { tipo, pos } = target.dataset;
                    delete season.pontuacao[tipo][pos];
                    renderAdminPage();
                }
            });
            
            document.getElementById('btn-ver-grafico').addEventListener('click', () => {
                const season = getCurrentSeason();
                const corridasFinalizadas = season.calendario.filter(c => c.status === 'finalizada').sort((a,b) => a.id - b.id);
                if (corridasFinalizadas.length < 1) { alert('É necessário ter pelo menos 1 corrida finalizada.'); return; }
                const labels = corridasFinalizadas.map(c => c.nome);
                const datasets = season.equipes.map(equipe => {
                    const data = [];
                    let pontosAcumulados = 0;
                    const pilotosDaEquipeIds = season.pilotos.filter(p => p.equipeId === equipe.id).map(p => p.id);
                    corridasFinalizadas.forEach(corrida => {
                        let pontosDaCorrida = 0;
                        pilotosDaEquipeIds.forEach(pilotoId => {
                            const res = corrida.resultados;
                            Object.entries(res.grid).forEach(([pos, pId]) => { if(pId == pilotoId && season.pontuacao.quali[pos]) pontosDaCorrida += (season.pontuacao.quali[pos] || 0); });
                            if (corrida.isSprint) {
                                const sprintPos = Object.keys(res.sprint).find(pos => res.sprint[pos] == pilotoId);
                                if (sprintPos) pontosDaCorrida += (season.pontuacao.sprint[sprintPos] || 0);
                            }
                            const racePos = Object.keys(res.corrida).find(pos => res.corrida[pos] == pilotoId);
                            if (racePos && res.corrida[racePos] !== 'DNF') pontosDaCorrida += (season.pontuacao.corrida[racePos] || 0);
                            if(res.voltaRapida == pilotoId) {
                                const posCorrida = Object.keys(res.corrida).find(pos => res.corrida[pos] == res.voltaRapida);
                                if (posCorrida && posCorrida <= 10) pontosDaCorrida += season.pontuacao.voltaRapida;
                            }
                        });
                        pontosAcumulados += pontosDaCorrida;
                        data.push(pontosAcumulados);
                    });
                    return { label: equipe.nome, data: data, borderColor: equipe.cor, backgroundColor: equipe.cor, fill: false, tension: 0.1 };
                });
                showModal(`<h3>Evolução das Equipes</h3><canvas id="teamEvolutionChart"></canvas><button onclick="hideModal()" class="btn btn-secundario" style="margin-top: 15px;">Fechar</button>`);
                const ctx = document.getElementById('teamEvolutionChart').getContext('2d');
                if (teamChart) teamChart.destroy();
                teamChart = new Chart(ctx, { type: 'line', data: { labels, datasets } });
            });

            document.getElementById('btn-share').addEventListener('click', async () => {
                const season = getCurrentSeason();
                if (!season) return;
                try {
                    const jsonString = JSON.stringify(season);
                    const compressed = pako.deflate(jsonString, { to: 'string' });
                    const encoded = btoa(compressed);
                    
                    showModal(`<h3>Código de Compartilhamento</h3><p>Envie este código para seus amigos.</p><textarea rows="4" style="width:100%; margin-top:10px; font-size: 0.8rem;" readonly>${encoded}</textarea><button id="copy-link-btn" class="btn btn-principal" style="margin-top:10px;">Copiar Código</button>`);
                    
                    document.getElementById('copy-link-btn').addEventListener('click', (e) => {
                        navigator.clipboard.writeText(encoded).then(() => {
                            e.target.textContent = 'Copiado!';
                        }).catch(err => {
                            alert('Falha ao copiar o código.');
                        });
                    });
                } catch (err) {
                    alert('Erro ao gerar o código de compartilhamento.');
                    console.error(err);
                }
            });
            
            document.getElementById('form-load-shared').addEventListener('submit', (e) => {
                e.preventDefault();
                const code = document.getElementById('shared-code').value;
                try {
                    const compressed = atob(code);
                    const jsonString = pako.inflate(compressed, { to: 'string' });
                    const sharedSeason = JSON.parse(jsonString);
                    
                    if (!sharedSeason.id || !sharedSeason.nome) throw new Error("Código inválido.");

                    state.sharedSeasons[sharedSeason.id] = sharedSeason;
                    saveState();
                    renderAmigosPage();
                    e.target.reset();
                    alert(`Temporada "${sharedSeason.nome}" carregada com sucesso!`);
                } catch (err) {
                    alert('Código inválido ou corrompido. Verifique se copiou corretamente.');
                    console.error("Erro ao carregar dados compartilhados:", err);
                }
            });
            
            document.getElementById('modal-backdrop').addEventListener('click', e => { if (e.target.id === 'modal-backdrop') hideModal(); });
            
            const checkInitialState = () => {
                loadState();
                document.querySelector('.nav-button[data-page="admin"]').classList.remove('hidden');
                document.getElementById('readonly-banner').classList.add('hidden');
                render();
            };

            checkInitialState();
            
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js').then(reg => console.log('SW registered.'), err => console.log('SW registration failed: ', err));
                });
            }
        });
    </script>
</body>
</html>
